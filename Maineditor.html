```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IGA Executive Brief Designer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Optional fonts (non-blocking) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Source+Serif+4:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --page-width: 210mm;
      --page-height: 297mm;
      --page-margin: 12mm;
      --ui-font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --transition-fast: 0.16s ease-out;
      --border-radius-sm: 4px;
      --border-radius-md: 6px;
      --shadow-soft: 0 4px 14px rgba(0,0,0,0.10);
      --shadow-soft-strong: 0 8px 26px rgba(0,0,0,0.12);

      /* Defaults (overridden by theme) */
      --font-body: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --font-serif: "Source Serif 4", "Georgia", "Times New Roman", serif;

      --page-bg: #ffffff;
      --page-border: #d6dce5;
      --page-footer-color: #888;

      --text-color: #111827;
      --muted-text: #6b7280;
      --link-color: #1d4ed8;

      --accent-primary: #004f9e;
      --accent-secondary: #fb923c;

      --cta-blue-bg: #e5f1ff;
      --cta-blue-border: #1d4ed8;
      --cta-green-bg: #e6f7ed;
      --cta-green-border: #16a34a;
      --cta-yellow-bg: #fff7e5;
      --cta-yellow-border: #f59e0b;
      --cta-red-bg: #fee2e2;
      --cta-red-border: #dc2626;

      --divider-color: #e5e7eb;
      --table-border: #d1d5db;
      --table-header-bg: #f3f4f6;

      --highlight-bg: #fff3b0;

      --snackbar-bg: rgba(17,24,39,0.96);
      --snackbar-color: #f9fafb;

      /* Shared block background tokens */
      --block-bg-soft: rgba(249,250,251,0.96);
      --block-bg-softer: rgba(249,250,251,0.9);
      --quote-bg: rgba(249,250,251,0.9);
      --table-bg: rgba(249,250,251,0.96);
      --image-bg: rgba(249,250,251,0.96);
      --cta-label-color: #374151;
    }

    /* IGA THEME */
    body.theme-iga {
      --font-body: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

      --page-bg: #ffffff;
      --page-border: #d6dce5;
      --page-footer-color: #6b7280;
      --text-color: #111827;
      --muted-text: #6b7280;
      --link-color: #1d4ed8;

      --accent-primary: #004f9e;
      --accent-secondary: #fb923c;

      --cta-blue-bg: #e5f1ff;
      --cta-blue-border: #1d4ed8;
      --cta-green-bg: #e6f7ed;
      --cta-green-border: #16a34a;
      --cta-yellow-bg: #fff7e5;
      --cta-yellow-border: #d97706;
      --cta-red-bg: #fee2e2;
      --cta-red-border: #b91c1c;

      --divider-color: #e5e7eb;
      --table-border: #d1d5db;
      --table-header-bg: #f3f4f6;

      --highlight-bg: #fff3b0;

      --block-bg-soft: rgba(249,250,251,0.96);
      --block-bg-softer: rgba(249,250,251,0.9);
      --quote-bg: rgba(249,250,251,0.9);
      --table-bg: rgba(249,250,251,0.96);
      --image-bg: rgba(249,250,251,0.96);
      --cta-label-color: #374151;
    }

    /* FT-STYLE THEME */
    body.theme-ft {
      --font-body: "Source Serif 4", "Georgia", "Times New Roman", serif;
      --ui-font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

      --page-bg: #f6e7dc; /* warm newsprint */
      --page-border: #d9b8a3;
      --page-footer-color: #7b6a5a;
      --text-color: #2b2119;
      --muted-text: #8b7a6a;
      --link-color: #005f6b;

      --accent-primary: #b05f3c;
      --accent-secondary: #c89a5b;

      --cta-blue-bg: #f0e3d8;
      --cta-blue-border: #8b7a6a;
      --cta-green-bg: #e6f0e6;
      --cta-green-border: #5b8a5b;
      --cta-yellow-bg: #f7ebd2;
      --cta-yellow-border: #c89a5b;
      --cta-red-bg: #f6d6d6;
      --cta-red-border: #b05f3c;

      --divider-color: #d3bda8;
      --table-border: #c7aa91;
      --table-header-bg: #e8cfb9;

      --highlight-bg: #fdf0c2;
      --snackbar-bg: rgba(32,24,19,0.98);
      --snackbar-color: #fff7ec;

      --block-bg-soft: #f9eee4;
      --block-bg-softer: #f7e5d8;
      --quote-bg: #f8e9dd;
      --table-bg: #f9eee4;
      --image-bg: #f9eee4;
      --cta-label-color: #5c4a3d;
    }

    /* Global layout */
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: var(--text-color);
      font-family: var(--font-body);
      -webkit-font-smoothing: antialiased;
    }

    #app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Top toolbar */
    #app-header {
      position: sticky;
      top: 0;
      z-index: 40;
      padding: 8px 16px;
      background: rgba(17,24,39,0.96);
      color: #e5e7eb;
      display: flex;
      flex-wrap: wrap;
      gap: 10px 24px;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.35);
      font-family: var(--ui-font);
    }

    #app-title {
      font-weight: 600;
      letter-spacing: 0.02em;
      font-size: 14px;
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin-right: 18px;
      color: #f9fafb;
    }

    #app-title span.sub {
      font-weight: 400;
      font-size: 11px;
      color: #9ca3af;
    }

    .toolbar-group {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .toolbar-label {
      font-size: 10px;
      text-transform: uppercase;
      color: #9ca3af;
      margin-right: 4px;
    }

    button,
    select {
      font-family: var(--ui-font);
      font-size: 11px;
    }

    .toolbar-btn {
      padding: 4px 8px;
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(156,163,175,0.6);
      background: rgba(17,24,39,0.85);
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .toolbar-btn:hover {
      background: #111827;
      border-color: #f97316;
      color: #f9fafb;
      box-shadow: 0 0 0 1px rgba(249,115,22,0.18);
      transform: translateY(-0.5px);
    }

    .toolbar-btn.primary {
      border-color: #f97316;
      color: #fed7aa;
    }

    .toolbar-btn.danger {
      border-color: #b91c1c;
      color: #fecaca;
    }

    .toolbar-btn-icon {
      font-size: 12px;
    }

    #theme-select {
      padding: 3px 6px;
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(156,163,175,0.7);
      background: #111827;
      color: #e5e7eb;
      outline: none;
      cursor: pointer;
    }

    #editor-root-wrapper {
      flex: 1;
      overflow-y: auto;
      padding: 16px 0 32px;
    }

    #editor-root {
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }

    /* Page containers */
    .page-container {
      position: relative;
      width: 100%;
      max-width: calc(var(--page-width) * 0.8);
      background: var(--page-bg);
      color: var(--text-color);
      border: 1px solid var(--page-border);
      border-radius: 6px;
      box-shadow: var(--shadow-soft);
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 900px;
      overflow: hidden;
    }

    .page-body {
      padding: var(--page-margin);
      padding-bottom: 28px;
      flex: 1;
      position: relative;
    }

    .page-footer {
      padding: 6px 10px;
      font-size: 10px;
      color: var(--page-footer-color);
      text-align: right;
      border-top: 1px solid var(--page-border);
      background: rgba(0,0,0,0.02);
      font-family: var(--ui-font);
    }

    /* Page controls */
    .page-controls {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 10;
      font-family: var(--ui-font);
    }

    .page-control-btn {
      width: 22px;
      height: 22px;
      padding: 0;
      border-radius: 999px;
      border: 1px solid rgba(148,163,253,0.3);
      background: rgba(17,24,39,0.88);
      color: #e5e7eb;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.35);
      transition: all var(--transition-fast);
    }

    .page-control-btn:hover {
      background: #111827;
      border-color: #f97316;
      color: #fed7aa;
      transform: translateY(-1px);
    }

    .footnotes-page .page-controls {
      display: none;
    }

    /* Overlay grid */
    .page-overlay {
      pointer-events: none;
      position: absolute;
      inset: var(--page-margin);
      border: 1px dashed rgba(148,163,253,0.4);
      border-radius: 2px;
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    body.show-overlay .page-overlay {
      opacity: 1;
    }

    /* Block selection */
    [data-deletable="true"] {
      position: relative;
      cursor: text;
    }

    .block-selected {
      outline: 2px solid #f97316;
      outline-offset: 1px;
      background-image: linear-gradient(to right, rgba(249,115,22,0.05), transparent);
    }

    .delete-icon {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      font-size: 11px;
      line-height: 16px;
      text-align: center;
      cursor: pointer;
      background: rgba(17,24,39,0.9);
      color: #fee2e2;
      display: none;
      user-select: none;
    }

    [data-deletable="true"]:hover > .delete-icon {
      display: block;
    }

    /* Typographic scale */
    .doc-title {
      font-size: 26px;
      font-weight: 600;
      margin: 0 0 6px;
    }

    .doc-subtitle {
      font-size: 14px;
      color: var(--muted-text);
      margin: 0 0 14px;
    }

    .section-heading {
      font-size: 16px;
      font-weight: 600;
      margin: 16px 0 4px;
      padding-bottom: 2px;
      border-bottom: 2px solid var(--accent-primary);
    }

    .body-text {
      font-size: 12px;
      line-height: 1.6;
      margin: 6px 0;
    }

    .caption-text {
      font-size: 10px;
      color: var(--muted-text);
      margin-top: 2px;
    }

    .footnote-ref {
      font-size: 9px;
      vertical-align: super;
      cursor: pointer;
    }

    a {
      color: var(--link-color);
      text-decoration: underline;
    }

    .text-highlight {
      background: var(--highlight-bg);
    }

    /* CTA / Info Box */
    .cta-box {
      margin: 10px 0;
      padding: 8px 10px 8px;
      border-radius: var(--border-radius-md);
      border-left: 4px solid var(--cta-blue-border);
      background: var(--cta-blue-bg);
      font-size: 11px;
      position: relative;
    }

    .cta-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .cta-body {
      font-size: 11px;
    }

    .cta-type-switch {
      display: inline-flex;
      gap: 4px;
      margin-bottom: 4px;
      font-family: var(--ui-font);
    }

    .cta-type-switch button {
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      font-size: 9px;
      cursor: pointer;
      color: var(--cta-label-color);
    }

    .cta-type-switch button.active {
      border-color: var(--cta-blue-border);
      background: rgba(17,24,39,0.04);
      color: #111827;
    }

    .cta-green {
      border-left-color: var(--cta-green-border);
      background: var(--cta-green-bg);
    }

    .cta-yellow {
      border-left-color: var(--cta-yellow-border);
      background: var(--cta-yellow-bg);
    }

    .cta-red {
      border-left-color: var(--cta-red-border);
      background: var(--cta-red-bg);
    }

    /* Steps */
    .steps-block {
      margin: 10px 0;
      padding: 8px 10px;
      border-radius: var(--border-radius-md);
      border: 1px solid var(--divider-color);
      background: var(--block-bg-soft);
      font-size: 11px;
    }

    .steps-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .styled-steps {
      padding-left: 16px;
      margin: 4px 0 4px;
    }

    .styled-steps li {
      margin: 2px 0;
    }

    .steps-add {
      border: none;
      background: transparent;
      color: var(--accent-primary);
      cursor: pointer;
      font-size: 10px;
      padding: 2px 0;
    }

    /* FAQ */
    .faq-block {
      margin: 10px 0;
      padding: 8px 10px;
      border-radius: var(--border-radius-md);
      border: 1px solid var(--divider-color);
      background: var(--block-bg-soft);
      font-size: 11px;
    }

    .faq-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .faq-list {
      padding-left: 14px;
      margin: 4px 0;
    }

    .faq-q {
      font-weight: 600;
    }

    .faq-a {
      margin-left: 4px;
    }

    .faq-add {
      border: none;
      background: transparent;
      color: var(--accent-primary);
      cursor: pointer;
      font-size: 10px;
      padding: 2px 0;
    }

    /* Quote */
    .quote-block {
      margin: 10px 0;
      padding: 8px 10px;
      border-left: 3px solid var(--accent-primary);
      background: var(--quote-bg);
      font-size: 11px;
      font-style: italic;
    }

    .quote-source {
      margin-top: 2px;
      font-size: 10px;
      font-style: normal;
      color: var(--muted-text);
    }

    /* Divider */
    .divider-block {
      margin: 10px 0;
      position: relative;
    }

    .section-divider {
      border: none;
      border-top: 1px solid var(--divider-color);
      margin: 4px 0;
    }

    /* Citation */
    .citation-block {
      font-size: 10px;
      color: var(--muted-text);
      font-style: italic;
      margin: 4px 0;
    }

    /* Tables */
    .table-block {
      margin: 10px 0;
      padding: 6px 6px 4px;
      border-radius: var(--border-radius-md);
      border: 1px solid var(--table-border);
      background: var(--table-bg);
      font-size: 10px;
      overflow-x: auto;
    }

    .iga-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
      table-layout: fixed;           /* keeps layout stable */
    }

    .iga-table th,
    .iga-table td {
      border: 1px solid var(--table-border);
      padding: 4px 4px;
      vertical-align: top;
      position: relative;
      word-wrap: break-word;
      overflow-wrap: break-word;     /* avoid ugly overflow */
    }

    .iga-table th {
      background: var(--table-header-bg);
      font-weight: 600;
    }

    .table-controls {
      display: flex;
      gap: 4px;
      margin: 4px 0 0;
      font-family: var(--ui-font);
    }

    .table-controls button {
      border: none;
      background: transparent;
      font-size: 9px;
      cursor: pointer;
      color: var(--accent-primary);
      padding: 1px 4px;
      border-radius: 999px;
    }

    .table-controls button:hover {
      background: rgba(17,24,39,0.04);
    }

    /* Column resize handle */
    .col-resize-handle {
      position: absolute;
      top: 0;
      right: -3px;
      width: 6px;
      height: 100%;
      cursor: col-resize;
      user-select: none;
      z-index: 5;
    }

    /* Images */
    .image-block {
      margin: 10px 0;
      padding: 4px 4px 2px;
      border-radius: var(--border-radius-md);
      border: 1px solid var(--divider-color);
      background: var(--image-bg);
      text-align: center;
      font-size: 10px;
    }

    .image-size-controls {
      display: inline-flex;
      gap: 2px;
      margin-bottom: 4px;
      font-family: var(--ui-font);
    }

    .image-size-controls button {
      border: none;
      background: transparent;
      font-size: 9px;
      padding: 1px 4px;
      border-radius: 999px;
      cursor: pointer;
      color: #6b7280;
    }

    .image-size-controls button.active {
      background: rgba(17,24,39,0.08);
      color: #111827;
    }

    .image-block img {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      max-height: 260px;
      object-fit: contain;
    }

    .image-size-s img { max-width: 40%; }
    .image-size-m img { max-width: 65%; }
    .image-size-l img { max-width: 100%; }

    /* Footnotes page */
    .footnotes-page .page-body {
      padding-top: 18px;
    }

    .footnotes-page h3.section-heading {
      margin-top: 0;
    }

    #footnote-list {
      font-size: 9px;
      margin-top: 4px;
      padding-left: 16px;
    }

    #footnote-list li {
      margin: 2px 0;
    }

    /* Floating block actions menu */
    .floating-menu {
      position: absolute;
      z-index: 60;
      padding: 4px;
      border-radius: var(--border-radius-md);
      background: rgba(17,24,39,0.98);
      color: #e5e7eb;
      box-shadow: var(--shadow-soft-strong);
      display: flex;
      gap: 2px;
      align-items: center;
      font-family: var(--ui-font);
      font-size: 10px;
      transform: translate(-50%, -110%);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-fast), transform var(--transition-fast);
    }

    .floating-menu.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -120%);
    }

    .floating-menu button {
      border: none;
      background: transparent;
      color: inherit;
      padding: 2px 4px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 10px;
    }

    .floating-menu button:hover {
      background: rgba(249,115,22,0.14);
      color: #fed7aa;
    }

    /* Text selection toolbar */
    #text-toolbar {
      position: absolute;
      z-index: 70;
      padding: 3px 4px;
      background: rgba(17,24,39,0.98);
      color: #e5e7eb;
      border-radius: var(--border-radius-md);
      display: flex;
      align-items: center;
      gap: 2px;
      box-shadow: var(--shadow-soft-strong);
      opacity: 0;
      pointer-events: none;
      transform: translate(-50%, -120%);
      font-family: var(--ui-font);
      font-size: 10px;
    }

    #text-toolbar.visible {
      opacity: 1;
      pointer-events: auto;
    }

    #text-toolbar button {
      border: none;
      background: transparent;
      color: inherit;
      padding: 2px 4px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 10px;
    }

    #text-toolbar button:hover {
      background: rgba(249,115,22,0.16);
      color: #fed7aa;
    }

    #paragraph-style {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 9px;
      padding: 1px 2px;
      cursor: pointer;
    }

    #link-input {
      width: 120px;
      border-radius: 3px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      font-size: 9px;
      padding: 1px 4px;
      outline: none;
    }

    /* Snackbar */
    #snackbar {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: var(--snackbar-bg);
      color: var(--snackbar-color);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 11px;
      font-family: var(--ui-font);
      box-shadow: 0 6px 20px rgba(0,0,0,0.45);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease-out, transform 0.18s ease-out;
      z-index: 90;
      max-width: 80vw;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #snackbar.show {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -4px);
    }

    /* Modals */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 80;
    }

    .modal-backdrop.visible {
      display: flex;
    }

    .modal-inner {
      background: #0f172a;
      padding: 12px 12px 10px;
      border-radius: 8px;
      box-shadow: 0 8px 26px rgba(0,0,0,0.6);
      color: #e5e7eb;
      width: 260px;
      font-family: var(--ui-font);
      font-size: 11px;
    }

    .modal-inner h3 {
      margin: 0 0 6px;
      font-size: 12px;
      font-weight: 600;
      color: #f97316;
    }

    .modal-inner label {
      display: block;
      margin: 4px 0 2px;
      font-size: 10px;
      color: #9ca3af;
    }

    .modal-inner input,
    .modal-inner textarea {
      width: 100%;
      border-radius: 4px;
      border: 1px solid #4b5563;
      padding: 4px;
      font-size: 10px;
      background: #020817;
      color: #e5e7eb;
      margin-bottom: 4px;
      outline: none;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 4px;
      margin-top: 2px;
    }

    .modal-actions button {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #6b7280;
      background: transparent;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 10px;
    }

    .modal-actions button.primary {
      border-color: #f97316;
      color: #fed7aa;
    }

    .modal-actions button:hover {
      background: rgba(15,23,42,0.86);
    }

    @page {
      size: A4;
      margin: 0;
    }

    /* Print styles */
    @media print {
      html,
      body {
        margin: 0;
        padding: 0;
        background: var(--page-bg);
      }

      #app-header,
      #block-actions,
      #text-toolbar,
      #snackbar,
      .page-controls,
      .page-overlay,
      .modal-backdrop {
        display: none !important;
      }

      #editor-root-wrapper {
        padding: 0 !important;
        background: var(--page-bg);
      }

      #editor-root {
        margin: 0;
        width: auto;
        align-items: stretch;
      }

      .page-container {
        box-shadow: none;
        border: none;
        border-radius: 0;
        width: 100%;
        max-width: none;
        min-height: auto;
        page-break-after: always;
        background: var(--page-bg);
      }

      .page-body {
        padding: var(--page-margin);
      }

      .page-break-avoider {
        break-inside: avoid;
        page-break-inside: avoid;
      }

      [data-deletable="true"] .delete-icon {
        display: none !important;
      }
    }
  </style>
</head>
<body class="theme-iga">
<div id="app">
  <header id="app-header">
    <div id="app-title">
      <span>IGA Executive Brief Designer</span>
      <span class="sub">Single-file themed WYSIWYG</span>
    </div>

    <div class="toolbar-group">
      <span class="toolbar-label">Pages</span>
      <button class="toolbar-btn primary" data-add-page><span class="toolbar-btn-icon">ï¼‹</span>Page</button>
      <button class="toolbar-btn" data-add-footnote>+ Footnote</button>
    </div>

    <div class="toolbar-group">
      <span class="toolbar-label">Insert block</span>
      <button class="toolbar-btn" data-add="section">Section</button>
      <button class="toolbar-btn" data-add="text">Text</button>
      <button class="toolbar-btn" data-add="cta">Info box</button>
      <button class="toolbar-btn" data-add="steps">Steps</button>
      <button class="toolbar-btn" data-add="faq">FAQ</button>
      <button class="toolbar-btn" data-add="quote">Quote</button>
      <button class="toolbar-btn" data-add="divider">Divider</button>
      <button class="toolbar-btn" data-add="citation">Citation</button>
      <button class="toolbar-btn" data-add="table-glance">At-a-glance</button>
      <button class="toolbar-btn" data-add="table-bai">Before/After/Impact</button>
      <button class="toolbar-btn" data-add="table-custom">Custom table</button>
      <button class="toolbar-btn" data-add="image">Image</button>
    </div>

    <div class="toolbar-group">
      <span class="toolbar-label">Theme</span>
      <select id="theme-select">
        <option value="iga">IGA</option>
        <option value="ft">FT-style</option>
      </select>
      <button class="toolbar-btn" id="toggle-overlay">Grid</button>
    </div>

    <div class="toolbar-group">
      <span class="toolbar-label">Edit</span>
      <button class="toolbar-btn" id="undo-btn">Undo</button>
      <button class="toolbar-btn" id="redo-btn">Redo</button>
      <button class="toolbar-btn" id="export-json">Export JSON</button>
      <button class="toolbar-btn" id="import-json">Import JSON</button>
      <button class="toolbar-btn" id="print-btn">Print / PDF</button>
    </div>
  </header>

  <div id="editor-root-wrapper">
    <main id="editor-root">
      <!-- Initial content page -->
      <div class="page-container" data-page-type="content">
        <div class="page-controls">
          <button class="page-control-btn" data-move-page-up title="Move page up">â†‘</button>
          <button class="page-control-btn" data-move-page-down title="Move page down">â†“</button>
          <button class="page-control-btn" data-dup-page title="Duplicate page">â§‰</button>
          <button class="page-control-btn" data-del-page title="Delete page">âœ•</button>
        </div>
        <div class="page-overlay"></div>
        <div class="page-body">
          <div class="doc-title" data-deletable="true" contenteditable="true">
            Executive Brief Title
            <span class="delete-icon" contenteditable="false">Ã—</span>
          </div>
          <p class="doc-subtitle body-text" data-deletable="true" contenteditable="true">
            Short positioning subtitle / context line.
            <span class="delete-icon" contenteditable="false">Ã—</span>
          </p>
          <h3 class="section-heading" data-deletable="true">
            <span contenteditable="true">Key messages</span>
            <span class="delete-icon" contenteditable="false">Ã—</span>
          </h3>
          <p class="body-text" data-deletable="true" contenteditable="true">
            Use this space to summarise the essentials in clear, direct language aligned with IGA style.
            <span class="delete-icon" contenteditable="false">Ã—</span>
          </p>
        </div>
        <div class="page-footer">Page 1</div>
      </div>

      <!-- Footnotes page (always last) -->
      <div class="page-container footnotes-page" data-page-type="footnotes">
        <div class="page-overlay"></div>
        <div class="page-body">
          <h3 class="section-heading">
            <span contenteditable="false">Footnotes</span>
          </h3>
          <ol id="footnote-list"></ol>
        </div>
        <div class="page-footer">Footnotes</div>
      </div>
    </main>
  </div>
</div>

<!-- Floating block actions menu -->
<div id="block-actions" class="floating-menu">
  <button data-action="move-up" title="Move block up">â†‘</button>
  <button data-action="move-down" title="Move block down">â†“</button>
  <button data-action="duplicate" title="Duplicate block(s)">â§‰</button>
  <button data-action="copy" title="Copy block(s)">â§„</button>
  <button data-action="cut" title="Cut block(s)">âœ‚</button>
  <button data-action="paste" title="Paste after selection">â§ </button>
  <button data-action="delete" title="Delete block(s)">âœ•</button>
</div>

<!-- Floating text formatting toolbar -->
<div id="text-toolbar">
  <button data-cmd="bold"><b>B</b></button>
  <button data-cmd="italic"><i>I</i></button>
  <button data-cmd="underline"><u>U</u></button>
  <button data-action="highlight">HL</button>
  <select id="paragraph-style">
    <option value="">Â¶</option>
    <option value="h1">H1</option>
    <option value="h2">H2</option>
    <option value="h3">H3</option>
    <option value="p">Body</option>
  </select>
  <button data-action="link">ðŸ”—</button>
  <button data-action="unlink">âœ•</button>
  <input type="url" id="link-input" placeholder="URL" />
</div>

<!-- Snackbar -->
<div id="snackbar"></div>

<!-- Modals -->
<div id="modal-backdrop" class="modal-backdrop">
  <div class="modal-inner" id="modal-inner"></div>
</div>

<!-- Hidden JSON input -->
<input type="file" id="json-file-input" accept="application/json" style="display:none" />

<script>
(function() {
  const editorRoot = document.getElementById('editor-root');
  const blockActions = document.getElementById('block-actions');
  const textToolbar = document.getElementById('text-toolbar');
  const snackbar = document.getElementById('snackbar');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const modalInner = document.getElementById('modal-inner');
  const jsonInput = document.getElementById('json-file-input');

  const INTERNAL_MARKER_START = '<!--EBD_INTERNAL_START-->';
  const INTERNAL_MARKER_END = '<!--EBD_INTERNAL_END-->';

  let internalClipboardHTML = '';
  let currentTextRange = null;

  let undoStack = [];
  let redoStack = [];
  let lastSerialized = null;
  let inputSnapshotTimer = null;
  let suppressSnapshots = false;

  // For column resizing
  let tableResizeState = null;

  function getCurrentTheme() {
    return document.body.classList.contains('theme-ft') ? 'ft' : 'iga';
  }

  function setTheme(theme) {
    document.body.classList.remove('theme-iga', 'theme-ft');
    if (theme === 'ft') {
      document.body.classList.add('theme-ft');
      document.getElementById('theme-select').value = 'ft';
    } else {
      document.body.classList.add('theme-iga');
      document.getElementById('theme-select').value = 'iga';
    }
  }

  function ensureFootnotesPage() {
    let footnotes = editorRoot.querySelector('.footnotes-page');
    if (!footnotes) {
      footnotes = document.createElement('div');
      footnotes.className = 'page-container footnotes-page';
      footnotes.dataset.pageType = 'footnotes';
      footnotes.innerHTML = `
        <div class="page-overlay"></div>
        <div class="page-body">
          <h3 class="section-heading"><span contenteditable="false">Footnotes</span></h3>
          <ol id="footnote-list"></ol>
        </div>
        <div class="page-footer">Footnotes</div>
      `;
      editorRoot.appendChild(footnotes);
    } else {
      editorRoot.appendChild(footnotes);
    }

    // Ensure existing lis are editable after reload/import
    const list = footnotes.querySelector('#footnote-list');
    if (list) {
      list.querySelectorAll('li').forEach(li => {
        if (!li.hasAttribute('contenteditable')) {
          li.contentEditable = 'true';
        }
      });
    }
  }

  function updatePageNumbers() {
    const pages = editorRoot.querySelectorAll('.page-container');
    let pageIndex = 1;
    pages.forEach(page => {
      const footer = page.querySelector('.page-footer');
      if (!footer) return;
      if (page.classList.contains('footnotes-page')) {
        footer.textContent = 'Footnotes';
      } else {
        footer.textContent = 'Page ' + pageIndex;
        page.dataset.pageNumber = String(pageIndex);
        pageIndex++;
      }
    });
  }

  function showSnackbar(message, duration = 2000) {
    snackbar.textContent = message;
    snackbar.classList.add('show');
    setTimeout(() => snackbar.classList.remove('show'), duration);
  }

  function clearBlockSelection() {
    editorRoot.querySelectorAll('.block-selected').forEach(el => el.classList.remove('block-selected'));
    hideBlockActions();
  }

  function getSelectedBlocks() {
    return Array.from(editorRoot.querySelectorAll('.block-selected')).filter(el =>
      el.closest('.page-container') &&
      !el.closest('.footnotes-page') &&
      el.dataset.deletable === 'true'
    );
  }

  function getLastSelectedBlock() {
    const blocks = getSelectedBlocks();
    return blocks.length ? blocks[blocks.length - 1] : null;
  }

  function isInEditor(node) {
    return node && editorRoot.contains(node);
  }

  function getActiveContentPageBody() {
    const sel = window.getSelection();
    if (sel && sel.rangeCount) {
      const node = sel.anchorNode;
      if (node) {
        const el = node.nodeType === 1 ? node : node.parentElement;
        const page = el && el.closest('.page-container');
        if (page && !page.classList.contains('footnotes-page')) {
          return page.querySelector('.page-body');
        }
      }
    }
    const pages = editorRoot.querySelectorAll('.page-container:not(.footnotes-page)');
    const last = pages[pages.length - 1];
    return last ? last.querySelector('.page-body') : null;
  }

  function ensureBlockVisible(block) {
    if (!block) return;
    block.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function serializeState() {
    const theme = getCurrentTheme();
    clearBlockSelection();
    hideTextToolbar();
    hideBlockActions();
    const html = editorRoot.innerHTML;
    return JSON.stringify({ theme, html });
  }

  function captureSnapshot() {
    if (suppressSnapshots) return;
    if (lastSerialized === null) {
      lastSerialized = serializeState();
      return;
    }
    undoStack.push(lastSerialized);
    if (undoStack.length > 50) undoStack.shift();
    redoStack.length = 0;
  }

  function afterChange() {
    if (suppressSnapshots) return;
    lastSerialized = serializeState();
  }

  function applyState(serialized) {
    suppressSnapshots = true;
    try {
      const state = JSON.parse(serialized);
      setTheme(state.theme || 'iga');
      editorRoot.innerHTML = state.html || '';
      ensureFootnotesPage();
      updatePageNumbers();
      renumberFootnotes();
      initAllTableResizers();
    } catch (e) {
      console.error(e);
      showSnackbar('Failed to apply state');
    }
    suppressSnapshots = false;
    lastSerialized = serialized;
  }

  function undo() {
    if (!undoStack.length) {
      showSnackbar('Nothing to undo');
      return;
    }
    const current = serializeState();
    const prev = undoStack.pop();
    redoStack.push(current);
    applyState(prev);
  }

  function redo() {
    if (!redoStack.length) {
      showSnackbar('Nothing to redo');
      return;
    }
    const current = serializeState();
    const next = redoStack.pop();
    undoStack.push(current);
    applyState(next);
  }

  function initHistory() {
    undoStack = [];
    redoStack = [];
    lastSerialized = serializeState();
  }

  /* -------- Footnotes: debounced auto-renumber + observer -------- */

  let footnoteMutationTimer = null;

  function scheduleFootnoteRenumber() {
    if (footnoteMutationTimer) return;
    footnoteMutationTimer = setTimeout(() => {
      renumberFootnotes();
      afterChange();
      footnoteMutationTimer = null;
    }, 80);
  }

  const footnoteObserver = new MutationObserver(mutations => {
    let changed = false;

    for (const m of mutations) {
      if (m.type !== 'childList') continue;

      // Look at removed nodes
      m.removedNodes.forEach(node => {
        if (node.nodeType !== 1) return;

        // If a footnote ref or footnote li itself was removed
        if (node.matches && (node.matches('.footnote-ref') || node.matches('#footnote-list li'))) {
          changed = true;
          return;
        }

        // Or if a container containing them was removed
        if (
          node.querySelector &&
          (node.querySelector('.footnote-ref') || node.querySelector('#footnote-list li'))
        ) {
          changed = true;
        }
      });

      // Direct removals from the footnote list
      if (!changed && m.target && m.target.id === 'footnote-list' && m.removedNodes.length) {
        changed = true;
      }
    }

    if (changed) {
      scheduleFootnoteRenumber();
    }
  });

  footnoteObserver.observe(editorRoot, {
    childList: true,
    subtree: true
  });

  /* -------- Block actions UI -------- */

  function positionBlockActions() {
    const last = getLastSelectedBlock();
    if (!last) {
      hideBlockActions();
      return;
    }
    const rect = last.getBoundingClientRect();
    blockActions.style.left = (rect.left + rect.width / 2 + window.scrollX) + 'px';
    blockActions.style.top = (rect.top + window.scrollY - 8) + 'px';
    blockActions.classList.add('visible');
  }

  function showBlockActions() {
    if (getSelectedBlocks().length) {
      positionBlockActions();
    } else {
      hideBlockActions();
    }
  }

  function hideBlockActions() {
    blockActions.classList.remove('visible');
  }

  /* -------- Text toolbar / selection -------- */

  function selectionWithinEditor() {
    const sel = window.getSelection();
    if (!sel || !sel.rangeCount) return false;
    const range = sel.getRangeAt(0);
    return isInEditor(range.commonAncestorContainer);
  }

  function isToolbarActiveElement() {
    const active = document.activeElement;
    return active && textToolbar.contains(active);
  }

  function updateTextToolbar() {
    if (!selectionWithinEditor()) {
      if (isToolbarActiveElement()) return;
      hideTextToolbar();
      return;
    }
    const sel = window.getSelection();
    if (sel.isCollapsed) {
      if (isToolbarActiveElement()) return;
      hideTextToolbar();
      return;
    }
    currentTextRange = sel.getRangeAt(0).cloneRange();
    const rect = currentTextRange.getBoundingClientRect();
    if (!rect || (!rect.width && !rect.height)) {
      hideTextToolbar();
      return;
    }
    textToolbar.style.left = (rect.left + rect.width / 2 + window.scrollX) + 'px';
    textToolbar.style.top = (rect.top + window.scrollY - 6) + 'px';
    textToolbar.classList.add('visible');
  }

  function hideTextToolbar() {
    textToolbar.classList.remove('visible');
    currentTextRange = null;
    const linkInput = document.getElementById('link-input');
    if (linkInput) linkInput.value = '';
  }

  function restoreSelection() {
    if (!currentTextRange) return;
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(currentTextRange);
  }

  const INLINE_FORMATS = {
    bold: { tagName: 'strong' },
    italic: { tagName: 'em' },
    underline: { tagName: 'u' }
  };

  function elementMatchesFormat(el, format) {
    if (!el || el.nodeType !== Node.ELEMENT_NODE) return false;
    if (el.tagName.toLowerCase() !== format.tagName.toLowerCase()) return false;
    if (format.className && !el.classList.contains(format.className)) return false;
    if (format.attributes) {
      for (const [key, value] of Object.entries(format.attributes)) {
        if (el.getAttribute(key) !== value) return false;
      }
    }
    return true;
  }

  function createFormatElement(format) {
    const el = document.createElement(format.tagName);
    if (format.className) el.classList.add(format.className);
    if (format.attributes) {
      for (const [key, value] of Object.entries(format.attributes)) {
        el.setAttribute(key, value);
      }
    }
    return el;
  }

  function splitTextBoundaries(range) {
    if (range.endContainer.nodeType === Node.TEXT_NODE) {
      const endNode = range.endContainer;
      if (range.endOffset > 0 && range.endOffset < endNode.length) {
        endNode.splitText(range.endOffset);
      }
    }
    if (range.startContainer.nodeType === Node.TEXT_NODE) {
      const startNode = range.startContainer;
      if (range.startOffset > 0 && range.startOffset < startNode.length) {
        const newNode = startNode.splitText(range.startOffset);
        range.setStart(newNode, 0);
      }
    }
  }

  function splitElementAt(element, offset) {
    if (!element || element.nodeType !== Node.ELEMENT_NODE) return null;
    const length = element.childNodes.length;
    if (offset <= 0 || offset >= length) return null;
    const clone = element.cloneNode(false);
    const parent = element.parentNode;
    if (!parent) return null;
    while (element.childNodes.length > offset) {
      clone.appendChild(element.childNodes[offset]);
    }
    parent.insertBefore(clone, element.nextSibling);
    return clone;
  }

  function splitMatchingAncestorsAtBoundary(range, format, isStart) {
    let container = isStart ? range.startContainer : range.endContainer;
    let offset = isStart ? range.startOffset : range.endOffset;

    if (container.nodeType === Node.TEXT_NODE) {
      const parent = container.parentNode;
      if (!parent) return;
      const index = Array.prototype.indexOf.call(parent.childNodes, container);
      container = parent;
      offset = isStart ? index : index + (offset === 0 ? 0 : 1);
    }

    while (container && container !== editorRoot && container.parentNode) {
      if (container.nodeType === Node.ELEMENT_NODE && elementMatchesFormat(container, format)) {
        const clone = splitElementAt(container, offset);
        if (clone) {
          if (isStart) {
            container = clone;
            offset = 0;
          } else {
            offset = container.childNodes.length;
          }
        }
      }
      const parent = container.parentNode;
      const idx = Array.prototype.indexOf.call(parent.childNodes, container);
      offset = isStart ? idx : idx + 1;
      container = parent;
    }
  }

  function getTextNodesInRange(range) {
    const nodes = [];
    const walker = document.createTreeWalker(
      range.commonAncestorContainer,
      NodeFilter.SHOW_TEXT,
      {
        acceptNode(node) {
          if (!node.nodeValue) return NodeFilter.FILTER_REJECT;
          try {
            return range.intersectsNode(node) ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
          } catch (e) {
            return NodeFilter.FILTER_REJECT;
          }
        }
      }
    );
    let current;
    while ((current = walker.nextNode())) {
      nodes.push(current);
    }
    return nodes;
  }

  function findMatchingAncestor(node, format) {
    let el = node.nodeType === Node.ELEMENT_NODE ? node : node.parentElement;
    while (el && el !== editorRoot) {
      if (elementMatchesFormat(el, format)) return el;
      el = el.parentElement;
    }
    return null;
  }

  function unwrapElement(el) {
    const parent = el.parentNode;
    if (!parent) return;
    while (el.firstChild) {
      parent.insertBefore(el.firstChild, el);
    }
    el.remove();
  }

  function unwrapMatchingInFragment(root, predicate) {
    const toUnwrap = [];
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, null);
    let current;
    while ((current = walker.nextNode())) {
      if (predicate(current)) toUnwrap.push(current);
    }
    toUnwrap.reverse().forEach(unwrapElement);
  }

  function getFirstTextNode(node) {
    if (!node) return null;
    if (node.nodeType === Node.TEXT_NODE) return node;
    let child = node.firstChild;
    while (child) {
      const found = getFirstTextNode(child);
      if (found) return found;
      child = child.nextSibling;
    }
    return null;
  }

  function getLastTextNode(node) {
    if (!node) return null;
    if (node.nodeType === Node.TEXT_NODE) return node;
    let child = node.lastChild;
    while (child) {
      const found = getLastTextNode(child);
      if (found) return found;
      child = child.previousSibling;
    }
    return null;
  }

  function setSelectionFromInserted(nodes) {
    if (!nodes.length) return;
    const sel = window.getSelection();
    const range = document.createRange();
    const firstNode = nodes[0];
    const lastNode = nodes[nodes.length - 1];
    const startText = getFirstTextNode(firstNode);
    const endText = getLastTextNode(lastNode);
    if (startText) {
      range.setStart(startText, 0);
    } else {
      range.setStartBefore(firstNode);
    }
    if (endText) {
      range.setEnd(endText, endText.length);
    } else {
      range.setEndAfter(lastNode);
    }
    sel.removeAllRanges();
    sel.addRange(range);
    currentTextRange = range.cloneRange();
  }

  function mergeAdjacentFormat(el, format) {
    let target = el;
    let prev = target.previousSibling;
    if (prev && prev.nodeType === Node.ELEMENT_NODE && elementMatchesFormat(prev, format)) {
      while (target.firstChild) {
        prev.appendChild(target.firstChild);
      }
      target.remove();
      target = prev;
    }
    let next = target.nextSibling;
    while (next && next.nodeType === Node.ELEMENT_NODE && elementMatchesFormat(next, format)) {
      while (next.firstChild) {
        target.appendChild(next.firstChild);
      }
      const toRemove = next;
      next = next.nextSibling;
      toRemove.remove();
    }
    return target;
  }

  function cleanupEmptyInline(format) {
    const nodes = editorRoot.querySelectorAll(format.tagName);
    nodes.forEach(node => {
      if (!elementMatchesFormat(node, format)) return;
      if (!node.textContent && node.childNodes.length === 0) {
        node.remove();
      }
    });
  }

  function toggleInlineFormat(format, options = {}) {
    if (!currentTextRange) return;
    restoreSelection();
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    if (range.collapsed) return;

    splitTextBoundaries(range);
    splitMatchingAncestorsAtBoundary(range, format, true);
    splitMatchingAncestorsAtBoundary(range, format, false);

    const textNodes = getTextNodesInRange(range);
    if (!textNodes.length) return;

    const shouldRemove = !options.forceApply && !options.unwrapOnly && textNodes.every(node => findMatchingAncestor(node, format));
    const fragment = range.extractContents();

    if (options.stripExisting) {
      unwrapMatchingInFragment(fragment, el => elementMatchesFormat(el, format));
    }

    let insertedNodes = [];
    if (shouldRemove || options.unwrapOnly) {
      unwrapMatchingInFragment(fragment, el => elementMatchesFormat(el, format));
      insertedNodes = Array.from(fragment.childNodes);
      range.insertNode(fragment);
    } else {
      const wrapper = createFormatElement(format);
      unwrapMatchingInFragment(fragment, el => elementMatchesFormat(el, format));
      wrapper.appendChild(fragment);
      range.insertNode(wrapper);
      const merged = mergeAdjacentFormat(wrapper, format);
      insertedNodes = [merged];
    }

    cleanupEmptyInline(format);
    if (insertedNodes.length) {
      setSelectionFromInserted(insertedNodes);
    } else {
      currentTextRange = null;
    }

    if (options.hideToolbar) hideTextToolbar();
    else updateTextToolbar();
    scheduleInputSnapshot();
  }

  function applyInlineCmd(cmd) {
    const format = INLINE_FORMATS[cmd];
    if (!format) return;
    toggleInlineFormat(format);
  }

  function toggleHighlight() {
    const format = { tagName: 'mark', className: 'text-highlight' };
    toggleInlineFormat(format, { hideToolbar: true });
  }

  function applyParagraphStyle(style) {
    if (!currentTextRange) return;
    restoreSelection();
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    let el = range.startContainer;
    if (el.nodeType === Node.TEXT_NODE) el = el.parentElement;
    if (!el) return;
    let block = el.closest('.body-text, .section-heading, h1, h2, h3, p, .doc-title, .doc-subtitle');
    if (!block) block = el;

    function transform(tagName, className) {
      if (block.tagName && block.tagName.toLowerCase() === tagName.toLowerCase()) {
        block.className = className;
        return;
      }
      const replacement = document.createElement(tagName);
      replacement.className = className;
      replacement.innerHTML = block.innerHTML;
      block.parentNode.replaceChild(replacement, block);
    }

    if (style === 'h1') transform('h1', 'doc-title');
    else if (style === 'h2') transform('h2', 'section-heading');
    else if (style === 'h3') transform('h3', 'section-heading');
    else if (style === 'p') transform('p', 'body-text');

    scheduleInputSnapshot();
    hideTextToolbar();
  }

  function createLink(url) {
    if (!currentTextRange) return;
    if (!url) {
      hideTextToolbar();
      return;
    }
    restoreSelection();
    if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
    const format = {
      tagName: 'a',
      attributes: {
        href: url,
        target: '_blank',
        rel: 'noopener noreferrer'
      }
    };
    toggleInlineFormat(format, { forceApply: true, stripExisting: true, hideToolbar: true });
  }

  function removeLink() {
    if (!currentTextRange) return;
    const format = { tagName: 'a' };
    toggleInlineFormat(format, { unwrapOnly: true, hideToolbar: true });
  }

  /* -------- Footnotes add + renumber -------- */

  function addFootnote() {
    const sel = window.getSelection();
    if (!sel || !sel.rangeCount) {
      showSnackbar('Place the caret in body content first');
      return;
    }
    const range = sel.getRangeAt(0);
    const container = range.commonAncestorContainer.nodeType === 1
      ? range.commonAncestorContainer
      : range.commonAncestorContainer.parentElement;
    const page = container && container.closest('.page-container');
    if (!page || page.classList.contains('footnotes-page')) {
      showSnackbar('Footnotes can only be added in body pages');
      return;
    }

    captureSnapshot();
    const id = 'fn-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 8);

    const sup = document.createElement('sup');
    sup.className = 'footnote-ref';
    sup.dataset.uniqueId = id;
    sup.textContent = '[?]';

    range.collapse(false);
    range.insertNode(sup);
    range.setStartAfter(sup);
    range.setEndAfter(sup);
    sel.removeAllRanges();
    sel.addRange(range);

    const list = editorRoot.querySelector('.footnotes-page #footnote-list');
    const li = document.createElement('li');
    li.dataset.uniqueId = id;
    li.contentEditable = 'true';
    li.textContent = 'Your footnote text here.';
    list.appendChild(li);

    renumberFootnotes();
    afterChange();
  }

  function renumberFootnotes() {
    const footnotesPage = editorRoot.querySelector('.footnotes-page');
    if (!footnotesPage) return;
    const list = footnotesPage.querySelector('#footnote-list');
    if (!list) return;

    // Collect all refs from content pages
    const refNodes = [];
    const contentPages = editorRoot.querySelectorAll('.page-container:not(.footnotes-page)');
    contentPages.forEach(page => {
      page.querySelectorAll('.footnote-ref').forEach(ref => refNodes.push(ref));
    });

    // Map of existing lis by unique id
    const liMap = new Map();
    list.querySelectorAll('li[data-unique-id]').forEach(li => {
      liMap.set(li.dataset.uniqueId, li);
    });

    // If a li was deleted in the footnotes list, drop its refs
    refNodes.slice().forEach(ref => {
      if (!liMap.has(ref.dataset.uniqueId)) {
        ref.remove();
      }
    });

    // Re-scan (some refs may have been removed)
    const validRefIds = new Set();
    const updatedRefNodes = [];
    contentPages.forEach(page => {
      page.querySelectorAll('.footnote-ref').forEach(ref => {
        updatedRefNodes.push(ref);
        validRefIds.add(ref.dataset.uniqueId);
      });
    });

    // Remove any lis that no longer have a live ref
    list.querySelectorAll('li[data-unique-id]').forEach(li => {
      if (!validRefIds.has(li.dataset.uniqueId)) {
        li.remove();
      }
    });

    // Now assign compact numbers in DOM order of refs
    const assigned = new Map();   // uniqueId -> number
    const orderedLis = [];
    let counter = 1;

    const currentLis = new Map();
    list.querySelectorAll('li[data-unique-id]').forEach(li => {
      currentLis.set(li.dataset.uniqueId, li);
      // ensure editable
      if (!li.hasAttribute('contenteditable')) {
        li.contentEditable = 'true';
      }
    });

    updatedRefNodes.forEach(ref => {
      const id = ref.dataset.uniqueId;
      if (!currentLis.has(id)) return; // orphan ref already removed or no li
      if (!assigned.has(id)) {
        assigned.set(id, counter++);
      }
      const num = assigned.get(id);
      ref.textContent = '[' + num + ']';
      const li = currentLis.get(id);
      if (li) {
        li.setAttribute('data-number', String(num));
        li.id = 'fn-' + num;
      }
    });

    // Order lis by their assigned numbers
    assigned.forEach((num, id) => {
      const li = currentLis.get(id);
      if (li) orderedLis[num - 1] = li;
    });

    const desiredOrder = orderedLis.filter(Boolean);
    desiredOrder.forEach((li, index) => {
      const currentChild = list.children[index];
      if (currentChild === li) return;
      if (currentChild) {
        list.insertBefore(li, currentChild);
      } else {
        list.appendChild(li);
      }
    });

    Array.from(list.children).forEach(child => {
      if (!desiredOrder.includes(child)) {
        child.remove();
      }
    });
  }

  /* -------- Page + block creation helpers -------- */

  function createPage() {
    const div = document.createElement('div');
    div.className = 'page-container';
    div.dataset.pageType = 'content';
    div.innerHTML = `
      <div class="page-controls">
        <button class="page-control-btn" data-move-page-up title="Move page up">â†‘</button>
        <button class="page-control-btn" data-move-page-down title="Move page down">â†“</button>
        <button class="page-control-btn" data-dup-page title="Duplicate page">â§‰</button>
        <button class="page-control-btn" data-del-page title="Delete page">âœ•</button>
      </div>
      <div class="page-overlay"></div>
      <div class="page-body">
        <h3 class="section-heading" data-deletable="true">
          <span contenteditable="true">New section title</span>
          <span class="delete-icon" contenteditable="false">Ã—</span>
        </h3>
        <p class="body-text" data-deletable="true" contenteditable="true">
          New paragraphâ€¦
          <span class="delete-icon" contenteditable="false">Ã—</span>
        </p>
      </div>
      <div class="page-footer"></div>
    `;
    return div;
  }

  function addPage() {
    captureSnapshot();
    const footnotes = editorRoot.querySelector('.footnotes-page');
    const page = createPage();
    editorRoot.insertBefore(page, footnotes);
    updatePageNumbers();
    renumberFootnotes();
    afterChange();
    ensureBlockVisible(page);
  }

  function addSectionBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const h = document.createElement('h3');
    h.className = 'section-heading';
    h.dataset.deletable = 'true';
    h.innerHTML = `<span contenteditable="true">New section title</span><span class="delete-icon" contenteditable="false">Ã—</span>`;
    body.appendChild(h);
    afterChange();
    ensureBlockVisible(h);
  }

  function addTextBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const p = document.createElement('p');
    p.className = 'body-text';
    p.dataset.deletable = 'true';
    p.contentEditable = 'true';
    p.innerHTML = 'New paragraphâ€¦<span class="delete-icon" contenteditable="false">Ã—</span>';
    body.appendChild(p);
    afterChange();
    ensureBlockVisible(p);
  }

  function createCtaBox() {
    const div = document.createElement('div');
    div.className = 'cta-box cta-blue page-break-avoider';
    div.dataset.deletable = 'true';
    div.dataset.generatedTitle = 'Info';
    div.innerHTML = `
      <span class="delete-icon" contenteditable="false">Ã—</span>
      <div class="cta-type-switch" contenteditable="false">
        <button data-cta="cta-blue" class="active">Info</button>
        <button data-cta="cta-green">Action</button>
        <button data-cta="cta-yellow">Caution</button>
        <button data-cta="cta-red">Critical</button>
      </div>
      <div class="cta-title" contenteditable="true">Info</div>
      <div class="cta-body" contenteditable="true">Key message textâ€¦</div>
    `;
    return div;
  }

  function addCtaBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const cta = createCtaBox();
    body.appendChild(cta);
    afterChange();
    ensureBlockVisible(cta);
  }

  function createStepsBlock() {
    const div = document.createElement('div');
    div.className = 'steps-block page-break-avoider';
    div.dataset.deletable = 'true';
    div.innerHTML = `
      <span class="delete-icon" contenteditable="false">Ã—</span>
      <div class="steps-title" contenteditable="true">Steps for implementation</div>
      <ol class="styled-steps">
        <li contenteditable="true">Step 1â€¦</li>
        <li contenteditable="true">Step 2â€¦</li>
        <li contenteditable="true">Step 3â€¦</li>
      </ol>
      <button class="steps-add" contenteditable="false">+ Add step</button>
    `;
    return div;
  }

  function addStepsBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const block = createStepsBlock();
    body.appendChild(block);
    afterChange();
    ensureBlockVisible(block);
  }

  function createFaqBlock() {
    const div = document.createElement('div');
    div.className = 'faq-block page-break-avoider';
    div.dataset.deletable = 'true';
    div.innerHTML = `
      <span class="delete-icon" contenteditable="false">Ã—</span>
      <div class="faq-title" contenteditable="true">Frequently asked questions</div>
      <ol class="faq-list">
        <li>
          <div class="faq-q" contenteditable="true">Q: â€¦</div>
          <div class="faq-a" contenteditable="true">A: â€¦</div>
        </li>
      </ol>
      <button class="faq-add" contenteditable="false">+ Add FAQ</button>
    `;
    return div;
  }

  function addFaqBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const block = createFaqBlock();
    body.appendChild(block);
    afterChange();
    ensureBlockVisible(block);
  }

  function addQuoteBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const div = document.createElement('div');
    div.className = 'quote-block';
    div.dataset.deletable = 'true';
    div.innerHTML = `
      <span class="delete-icon" contenteditable="false">Ã—</span>
      <blockquote class="quote-body" contenteditable="true">â€œQuoted textâ€¦â€</blockquote>
      <div class="quote-source" contenteditable="true">Source / speaker (optional)</div>
    `;
    body.appendChild(div);
    afterChange();
    ensureBlockVisible(div);
  }

  function addDividerBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const div = document.createElement('div');
    div.className = 'divider-block page-break-avoider';
    div.dataset.deletable = 'true';
    div.innerHTML = `
      <hr class="section-divider" />
      <span class="delete-icon" contenteditable="false">Ã—</span>
    `;
    body.appendChild(div);
    afterChange();
    ensureBlockVisible(div);
  }

  function addCitationBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const p = document.createElement('p');
    p.className = 'citation-block';
    p.dataset.deletable = 'true';
    p.contentEditable = 'true';
    p.innerHTML = '(Source: â€¦)<span class="delete-icon" contenteditable="false">Ã—</span>';
    body.appendChild(p);
    afterChange();
    ensureBlockVisible(p);
  }

  function createAtAGlanceTable() {
    const div = document.createElement('div');
    div.className = 'table-block page-break-avoider';
    div.dataset.deletable = 'true';
    div.innerHTML = `
      <span class="delete-icon" contenteditable="false">Ã—</span>
      <table class="iga-table">
        <thead>
          <tr>
            <th contenteditable="true">Theme</th>
            <th contenteditable="true">Detail</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td contenteditable="true">Audience</td>
            <td contenteditable="true">Who this is forâ€¦</td>
          </tr>
          <tr>
            <td contenteditable="true">Objective</td>
            <td contenteditable="true">What we need them to doâ€¦</td>
          </tr>
          <tr>
            <td contenteditable="true">Timing</td>
            <td contenteditable="true">Key datesâ€¦</td>
          </tr>
        </tbody>
      </table>
      <div class="table-controls" contenteditable="false">
        <button data-table-action="add-row">+ Row</button>
        <button data-table-action="add-col">+ Col</button>
        <button data-table-action="del-row">- Row</button>
        <button data-table-action="del-col">- Col</button>
      </div>
    `;
    const table = div.querySelector('table');
    initTableResizing(table);
    return div;
  }

  function createBAITable() {
    const div = document.createElement('div');
    div.className = 'table-block page-break-avoider';
    div.dataset.deletable = 'true';
    div.innerHTML = `
      <span class="delete-icon" contenteditable="false">Ã—</span>
      <table class="iga-table">
        <thead>
          <tr>
            <th contenteditable="true">Before</th>
            <th contenteditable="true">After</th>
            <th contenteditable="true">Impact</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td contenteditable="true">Current stateâ€¦</td>
            <td contenteditable="true">Target stateâ€¦</td>
            <td contenteditable="true">Outcome / benefitâ€¦</td>
          </tr>
        </tbody>
      </table>
      <div class="table-controls" contenteditable="false">
        <button data-table-action="add-row">+ Row</button>
        <button data-table-action="add-col">+ Col</button>
        <button data-table-action="del-row">- Row</button>
        <button data-table-action="del-col">- Col</button>
      </div>
    `;
    const table = div.querySelector('table');
    initTableResizing(table);
    return div;
  }

  function addAtAGlanceTable() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const block = createAtAGlanceTable();
    body.appendChild(block);
    afterChange();
    ensureBlockVisible(block);
  }

  function addBAITable() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const block = createBAITable();
    body.appendChild(block);
    afterChange();
    ensureBlockVisible(block);
  }

  function openCustomTableModal() {
    openModal({
      title: 'Add custom table',
      body: `
        <label>Rows</label>
        <input type="number" id="tbl-rows" min="1" max="40" value="3" />
        <label>Columns</label>
        <input type="number" id="tbl-cols" min="1" max="8" value="3" />
        <label>Or paste TSV (overrides rows/cols)</label>
        <textarea id="tbl-tsv" rows="4" placeholder="cell1\tcell2\ncell3\tcell4"></textarea>
      `,
      onConfirm: () => {
        const rowsInput = modalInner.querySelector('#tbl-rows');
        const colsInput = modalInner.querySelector('#tbl-cols');
        const tsvInput = modalInner.querySelector('#tbl-tsv');
        const tsv = (tsvInput.value || '').trim();
        let rows = parseInt(rowsInput.value, 10) || 1;
        let cols = parseInt(colsInput.value, 10) || 1;

        let data = [];
        if (tsv) {
          const lines = tsv.split(/\r?\n/);
          lines.forEach(line => {
            const cells = line.split('\t');
            data.push(cells);
            if (cells.length > cols) cols = cells.length;
          });
          rows = data.length;
        }

        const body = getActiveContentPageBody();
        if (!body) {
          closeModal();
          return;
        }

        captureSnapshot();

        const block = document.createElement('div');
        block.className = 'table-block page-break-avoider';
        block.dataset.deletable = 'true';

        let html = `
          <span class="delete-icon" contenteditable="false">Ã—</span>
          <table class="iga-table">
            <tbody>
        `;
        for (let r = 0; r < rows; r++) {
          html += '<tr>';
          for (let c = 0; c < cols; c++) {
            const txt = data[r] && data[r][c] ? data[r][c] : ' ';
            html += `<td contenteditable="true">${txt}</td>`;
          }
          html += '</tr>';
        }
        html += `
            </tbody>
          </table>
          <div class="table-controls" contenteditable="false">
            <button data-table-action="add-row">+ Row</button>
            <button data-table-action="add-col">+ Col</button>
            <button data-table-action="del-row">- Row</button>
            <button data-table-action="del-col">- Col</button>
          </div>
        `;
        block.innerHTML = html;
        const table = block.querySelector('table');
        initTableResizing(table);
        body.appendChild(block);
        afterChange();
        ensureBlockVisible(block);
        closeModal();
      }
    });
  }

  function addImageBlockWithURL(url) {
    if (!url) return;
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const div = document.createElement('div');
    div.className = 'image-block image-size-m page-break-avoider';
    div.dataset.deletable = 'true';
    div.innerHTML = `
      <span class="delete-icon" contenteditable="false">Ã—</span>
      <div class="image-size-controls" contenteditable="false">
        <button data-size="s">S</button>
        <button data-size="m" class="active">M</button>
        <button data-size="l">L</button>
      </div>
      <img src="${url}" alt="">
    `;
    body.appendChild(div);
    afterChange();
    ensureBlockVisible(div);
  }

  function openImageModal() {
    openModal({
      title: 'Add image',
      body: `
        <label>Image URL</label>
        <input type="url" id="img-url" placeholder="https://example.com/image.png" />
      `,
      onConfirm: () => {
        const input = modalInner.querySelector('#img-url');
        const url = input.value.trim();
        if (!url) {
          showSnackbar('Image URL required');
          return;
        }
        addImageBlockWithURL(url);
        closeModal();
      }
    });
  }

  /* -------- Modal helpers -------- */

  function openModal({ title, body, onConfirm }) {
    modalInner.innerHTML = `
      <h3>${title}</h3>
      ${body}
      <div class="modal-actions">
        <button type="button" data-modal-cancel>Cancel</button>
        <button type="button" class="primary" data-modal-confirm>OK</button>
      </div>
    `;
    modalBackdrop.classList.add('visible');
    modalInner.querySelector('[data-modal-cancel]').onclick = closeModal;
    modalInner.querySelector('[data-modal-confirm]').onclick = () => {
      if (typeof onConfirm === 'function') onConfirm();
    };
  }

  function closeModal() {
    modalBackdrop.classList.remove('visible');
    modalInner.innerHTML = '';
  }

  /* -------- Table controls + resizing -------- */

  function handleTableControl(btn) {
    const action = btn.dataset.tableAction;
    const block = btn.closest('.table-block');
    if (!block) return;
    const table = block.querySelector('table');
    if (!table) return;

    captureSnapshot();

    if (action === 'add-row') {
      const tbody = table.tBodies[0] || table.createTBody();
      const refRow = tbody.rows[tbody.rows.length - 1] || (table.tHead && table.tHead.rows[0]);
      const cols = refRow ? refRow.cells.length : 1;
      const row = tbody.insertRow(-1);
      for (let i = 0; i < cols; i++) {
        const cell = row.insertCell(-1);
        cell.contentEditable = 'true';
        cell.textContent = ' ';
      }
    } else if (action === 'add-col') {
      const rows = table.rows;
      for (let r = 0; r < rows.length; r++) {
        const cell = rows[r].insertCell(-1);
        cell.contentEditable = 'true';
        cell.textContent = ' ';
      }
    } else if (action === 'del-row') {
      const tbody = table.tBodies[0];
      if (tbody && tbody.rows.length > 0) tbody.deleteRow(-1);
    } else if (action === 'del-col') {
      const rows = table.rows;
      if (rows.length && rows[0].cells.length > 1) {
        for (let r = 0; r < rows.length; r++) {
          rows[r].deleteCell(-1);
        }
      }
    }

    const tbody = table.tBodies[0];
    if ((!tbody || !tbody.rows.length) && (!table.tHead || !table.tHead.rows.length)) {
      block.remove();
    }

    initTableResizing(table);
    afterChange();
  }

  function initTableResizing(table) {
    if (!table) return;
    // Remove existing handles
    table.querySelectorAll('.col-resize-handle').forEach(h => h.remove());

    const headerRow =
      (table.tHead && table.tHead.rows[0]) ||
      (table.tBodies[0] && table.tBodies[0].rows[0]);

    if (!headerRow) return;

    const cells = Array.from(headerRow.cells);
    if (cells.length <= 1) return;

    cells.forEach((cell, index) => {
      // Optional: skip last column handle if you prefer
      if (index === cells.length - 1) return;

      const handle = document.createElement('div');
      handle.className = 'col-resize-handle';
      handle.contentEditable = 'false';
      handle.addEventListener('mousedown', e => {
        e.preventDefault();
        e.stopPropagation();
        startColumnResize(table, index, e);
      });
      cell.appendChild(handle);
    });
  }

  function startColumnResize(table, colIndex, event) {
    const startX = event.clientX;
    const colCells = Array.from(table.rows)
      .map(row => row.cells[colIndex])
      .filter(Boolean);
    if (!colCells.length) return;

    const startWidths = colCells.map(cell => cell.offsetWidth);

    tableResizeState = {
      table,
      colCells,
      startX,
      startWidths
    };

    document.addEventListener('mousemove', handleColumnResizeMove);
    document.addEventListener('mouseup', stopColumnResize);
  }

  function handleColumnResizeMove(e) {
    if (!tableResizeState) return;
    const deltaX = e.clientX - tableResizeState.startX;

    tableResizeState.colCells.forEach((cell, i) => {
      const base = tableResizeState.startWidths[i];
      const next = Math.max(40, base + deltaX);
      cell.style.width = next + 'px';
    });

    e.preventDefault();
  }

  function stopColumnResize() {
    if (!tableResizeState) return;
    document.removeEventListener('mousemove', handleColumnResizeMove);
    document.removeEventListener('mouseup', stopColumnResize);
    tableResizeState = null;
    scheduleInputSnapshot();
  }

  function initAllTableResizers() {
    editorRoot.querySelectorAll('table.iga-table').forEach(initTableResizing);
  }

  /* -------- Paste / sanitize / clipboard -------- */

  function insertPastedImage(file) {
    const reader = new FileReader();
    reader.onload = e => addImageBlockWithURL(e.target.result);
    reader.readAsDataURL(file);
  }

  function sanitizeExternalHTML(html) {
    const allowedTags = new Set([
      'P','H1','H2','H3','H4','UL','OL','LI','A','STRONG','EM',
      'B','I','TABLE','TBODY','THEAD','TR','TD','TH','BLOCKQUOTE','BR','SPAN'
    ]);
    const allowedAttrs = {
      'A': ['href'],
      'TD': [], 'TH': [], 'TABLE': [], 'TR': [], 'P': [], 'BLOCKQUOTE': [], 'SPAN': []
    };
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    function cleanse(node) {
      if (node.nodeType === Node.TEXT_NODE) return node.cloneNode(true);
      if (node.nodeType !== Node.ELEMENT_NODE) return document.createTextNode('');
      if (!allowedTags.has(node.tagName)) {
        const frag = document.createDocumentFragment();
        node.childNodes.forEach(child => {
          const c = cleanse(child);
          if (c) frag.appendChild(c);
        });
        return frag;
      }
      const el = document.createElement(node.tagName.toLowerCase());
      const allowed = allowedAttrs[node.tagName] || [];
      for (let attr of Array.from(node.attributes)) {
        if (attr.name.toLowerCase() === 'href' && /^https?:\/\//i.test(attr.value)) {
          el.setAttribute('href', attr.value);
        } else if (allowed.includes(attr.name.toLowerCase())) {
          el.setAttribute(attr.name, attr.value);
        }
      }
      node.childNodes.forEach(child => {
        const c = cleanse(child);
        if (c) el.appendChild(c);
      });
      return el;
    }

    const frag = document.createDocumentFragment();
    doc.body.childNodes.forEach(child => {
      const c = cleanse(child);
      if (c) frag.appendChild(c);
    });
    return frag;
  }

  function handlePaste(e) {
    if (!isInEditor(e.target)) return;
    const cd = e.clipboardData || window.clipboardData;
    if (!cd) return;

    const items = cd.items || [];
    for (let i = 0; i < items.length; i++) {
      const it = items[i];
      if (it.type && it.type.indexOf('image') === 0) {
        e.preventDefault();
        const file = it.getAsFile();
        if (file) insertPastedImage(file);
        return;
      }
    }

    const html = cd.getData('text/html');
    const text = cd.getData('text/plain');

    // Internal block copy/paste
    if (html && html.includes(INTERNAL_MARKER_START) && html.includes(INTERNAL_MARKER_END)) {
      e.preventDefault();
      const start = html.indexOf(INTERNAL_MARKER_START) + INTERNAL_MARKER_START.length;
      const end = html.indexOf(INTERNAL_MARKER_END);
      const blockHtml = html.slice(start, end);
      insertInternalBlocks(blockHtml);
      return;
    }

    if (html) {
      e.preventDefault();
      const safe = sanitizeExternalHTML(html);
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      captureSnapshot();
      const range = sel.getRangeAt(0);
      range.deleteContents();
      range.insertNode(safe);
      afterChange();
      return;
    }

    if (text) {
      e.preventDefault();
      const normalized = text.replace(/\r\n/g, '\n');
      const paragraphs = normalized
        .split(/\n{2,}/)
        .map(seg => seg.trim())
        .filter(seg => seg.length);

      if (!paragraphs.length) return;

      const escapeHtml = str => str.replace(/[&<>"']/g, ch => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[ch]);

      const sel = window.getSelection();
      if (sel && sel.rangeCount) {
        const range = sel.getRangeAt(0);
        const container = range.commonAncestorContainer.nodeType === Node.ELEMENT_NODE
          ? range.commonAncestorContainer
          : range.commonAncestorContainer.parentElement;
        const pageBody = container && container.closest('.page-body');

        if (pageBody) {
          captureSnapshot();
          const page = pageBody.closest('.page-container');
          if (page && page.classList.contains('footnotes-page')) {
            const inlineHtml = paragraphs
              .map(seg => escapeHtml(seg).replace(/\n/g, '<br>'))
              .join('<br><br>');
            document.execCommand('insertHTML', false, inlineHtml);
          } else {
            const blockHtml = paragraphs
              .map(seg => {
                const html = escapeHtml(seg).replace(/\n/g, '<br>');
                return `<p class="body-text" data-deletable="true" contenteditable="true">${html}<span class="delete-icon" contenteditable="false">Ã—</span></p>`;
              })
              .join('');
            document.execCommand('insertHTML', false, blockHtml);
          }
          afterChange();
          return;
        }
      }

      const body = getActiveContentPageBody();
      if (!body) return;
      captureSnapshot();
      paragraphs.forEach(seg => {
        const p = document.createElement('p');
        p.className = 'body-text';
        p.dataset.deletable = 'true';
        p.contentEditable = 'true';
        const lines = seg.split('\n');
        lines.forEach((line, index) => {
          if (index > 0) p.appendChild(document.createElement('br'));
          p.appendChild(document.createTextNode(line));
        });
        const icon = document.createElement('span');
        icon.className = 'delete-icon';
        icon.contentEditable = 'false';
        icon.textContent = 'Ã—';
        p.appendChild(icon);
        body.appendChild(p);
      });
      afterChange();
    }
  }

  function insertInternalBlocks(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    const blocks = Array.from(tmp.children);
    if (!blocks.length) return;

    const lastSelected = getLastSelectedBlock();
    const sel = window.getSelection();
    let insertAfter = lastSelected;

    if (!insertAfter && sel && sel.rangeCount) {
      const node = sel.anchorNode;
      const el = node && (node.nodeType === 1 ? node : node.parentElement);
      const blk = el && el.closest('[data-deletable="true"]');
      if (blk && !blk.closest('.footnotes-page')) insertAfter = blk;
    }

    const body = insertAfter ? insertAfter.closest('.page-body') : getActiveContentPageBody();
    if (!body) return;

    captureSnapshot();

    blocks.forEach(b => {
      if (b.dataset && b.dataset.deletable === 'true') {
        const clone = b.cloneNode(true);
        if (insertAfter) {
          insertAfter.insertAdjacentElement('afterend', clone);
          insertAfter = clone;
        } else {
          body.appendChild(clone);
        }
      }
    });

    renumberFootnotes();
    afterChange();
  }

  function copySelectedBlocks(isCut = false) {
    const blocks = getSelectedBlocks();
    if (!blocks.length) {
      showSnackbar('Select block(s) to copy');
      return;
    }
    const html = blocks.map(b => b.outerHTML).join('');
    internalClipboardHTML = html;
    const wrapped = INTERNAL_MARKER_START + html + INTERNAL_MARKER_END;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(wrapped).catch(() => {});
    }
    if (isCut) {
      captureSnapshot();
      blocks.forEach(b => b.remove());
      renumberFootnotes();
      afterChange();
      clearBlockSelection();
    }
    showSnackbar(isCut ? 'Block(s) cut' : 'Block(s) copied', 1200);
  }

  function pasteBlocksAfterSelection() {
    if (!internalClipboardHTML) {
      showSnackbar('Clipboard is empty');
      return;
    }
    insertInternalBlocks(internalClipboardHTML);
  }

  function moveBlocks(direction) {
    const blocks = getSelectedBlocks();
    if (!blocks.length) return;
    captureSnapshot();

    const sorted = blocks.slice().sort((a, b) =>
      a.compareDocumentPosition(b) & Node.DOCUMENT_POSITION_FOLLOWING ? -1 : 1
    );
    const isUp = direction === 'up';

    if (isUp) {
      sorted.forEach(block => {
        const prev = block.previousElementSibling;
        if (prev && prev.dataset.deletable === 'true') prev.before(block);
      });
    } else {
      sorted.reverse().forEach(block => {
        const next = block.nextElementSibling;
        if (next && next.dataset.deletable === 'true') next.after(block);
      });
    }

    renumberFootnotes();
    afterChange();
    showBlockActions();
  }

  function duplicateBlocks() {
    const blocks = getSelectedBlocks();
    if (!blocks.length) return;
    captureSnapshot();
    let lastClone = null;
    blocks.forEach(block => {
      const clone = block.cloneNode(true);
      block.insertAdjacentElement('afterend', clone);
      lastClone = clone;
    });
    renumberFootnotes();
    afterChange();
    clearBlockSelection();
    if (lastClone) {
      lastClone.classList.add('block-selected');
      ensureBlockVisible(lastClone);
      showBlockActions();
    }
  }

  function deleteBlocks() {
    const blocks = getSelectedBlocks();
    if (!blocks.length) return;
    captureSnapshot();
    blocks.forEach(b => b.remove());
    renumberFootnotes();
    afterChange();
    clearBlockSelection();
  }

  /* -------- Export / import -------- */

  function exportJSON() {
    const theme = getCurrentTheme();
    clearBlockSelection();
    hideTextToolbar();
    hideBlockActions();
    const content = `<main id="editor-root">${editorRoot.innerHTML}</main>`;
    const payload = {
      version: '1.0.0',
      timestamp: new Date().toISOString(),
      theme,
      content
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'executive-brief.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showSnackbar('JSON exported');
  }

  function importJSONFromFile(file) {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const obj = JSON.parse(e.target.result);
        if (!obj.content) throw new Error('Missing content');
        const parser = new DOMParser();
        const doc = parser.parseFromString(obj.content, 'text/html');
        const main = doc.querySelector('main#editor-root') || doc.querySelector('main') || doc.body;
        if (!main) throw new Error('Invalid content wrapper');

        suppressSnapshots = true;
        editorRoot.innerHTML = main.innerHTML;
        setTheme(obj.theme === 'ft' ? 'ft' : 'iga');
        ensureFootnotesPage();
        updatePageNumbers();
        renumberFootnotes();
        initAllTableResizers();
        suppressSnapshots = false;
        initHistory();
        showSnackbar('JSON imported');
      } catch (err) {
        console.error(err);
        showSnackbar('Import failed: ' + err.message);
        suppressSnapshots = false;
      }
    };
    reader.readAsText(file);
  }

  function scheduleInputSnapshot() {
    if (suppressSnapshots || inputSnapshotTimer) return;
    captureSnapshot();
    inputSnapshotTimer = setTimeout(() => {
      afterChange();
      inputSnapshotTimer = null;
    }, 400);
  }

  /* -------- Global click handler -------- */

  document.addEventListener('click', e => {
    const target = e.target;

    // Delete icon for blocks (not used on footnotes page)
    if (target.classList.contains('delete-icon')) {
      const block = target.closest('[data-deletable="true"]');
      if (block && editorRoot.contains(block) && !block.closest('.footnotes-page')) {
        captureSnapshot();
        block.remove();
        renumberFootnotes();
        afterChange();
        clearBlockSelection();
      }
      return;
    }

    if (target.classList.contains('steps-add')) {
      const block = target.closest('.steps-block');
      const ol = block && block.querySelector('.styled-steps');
      if (ol) {
        captureSnapshot();
        const li = document.createElement('li');
        li.contentEditable = 'true';
        li.textContent = 'New stepâ€¦';
        ol.appendChild(li);
        afterChange();
      }
      return;
    }

    if (target.classList.contains('faq-add')) {
      const block = target.closest('.faq-block');
      const ol = block && block.querySelector('.faq-list');
      if (ol) {
        captureSnapshot();
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="faq-q" contenteditable="true">Q: â€¦</div>
          <div class="faq-a" contenteditable="true">A: â€¦</div>
        `;
        ol.appendChild(li);
        afterChange();
      }
      return;
    }

    if (target.closest('.cta-type-switch') && target.dataset.cta) {
      const box = target.closest('.cta-box');
      if (box) {
        captureSnapshot();
        box.classList.remove('cta-blue','cta-green','cta-yellow','cta-red');
        box.classList.add(target.dataset.cta);
        box.querySelectorAll('.cta-type-switch button').forEach(btn => btn.classList.remove('active'));
        target.classList.add('active');
        const titleEl = box.querySelector('.cta-title');
        if (titleEl && !box.dataset.customTitle) {
          const map = {
            'cta-blue':'Info',
            'cta-green':'Action',
            'cta-yellow':'Caution',
            'cta-red':'Critical'
          };
          titleEl.textContent = map[target.dataset.cta] || 'Info';
          box.dataset.generatedTitle = titleEl.textContent;
        }
        afterChange();
      }
      return;
    }

    if (target.closest('.table-controls') && target.dataset.tableAction) {
      handleTableControl(target);
      return;
    }

    if (target.closest('.image-size-controls') && target.dataset.size) {
      const block = target.closest('.image-block');
      if (block) {
        captureSnapshot();
        block.classList.remove('image-size-s','image-size-m','image-size-l');
        block.classList.add('image-size-' + target.dataset.size);
        block.querySelectorAll('.image-size-controls button')
          .forEach(btn => btn.classList.remove('active'));
        target.classList.add('active');
        afterChange();
      }
      return;
    }

    // Page controls
    if (target.dataset.movePageUp !== undefined ||
        target.dataset.movePageDown !== undefined ||
        target.dataset.dupPage !== undefined ||
        target.dataset.delPage !== undefined) {
      const page = target.closest('.page-container');
      if (!page || page.classList.contains('footnotes-page')) return;
      const footnotes = editorRoot.querySelector('.footnotes-page');
      const contentPages = editorRoot.querySelectorAll('.page-container:not(.footnotes-page)');

      if (target.dataset.movePageUp !== undefined) {
        captureSnapshot();
        const prev = page.previousElementSibling;
        if (prev && !prev.classList.contains('footnotes-page')) {
          editorRoot.insertBefore(page, prev);
        }
        updatePageNumbers();
        renumberFootnotes();
        afterChange();
      }

      if (target.dataset.movePageDown !== undefined) {
        captureSnapshot();
        const next = page.nextElementSibling;
        if (next && next !== footnotes) {
          editorRoot.insertBefore(next, page);
        }
        updatePageNumbers();
        renumberFootnotes();
        afterChange();
      }

      if (target.dataset.dupPage !== undefined) {
        captureSnapshot();
        const clone = page.cloneNode(true);
        clone.querySelectorAll('.block-selected').forEach(el => el.classList.remove('block-selected'));
        editorRoot.insertBefore(clone, page.nextElementSibling);
        updatePageNumbers();
        renumberFootnotes();
        initAllTableResizers();
        afterChange();
      }

      if (target.dataset.delPage !== undefined) {
        if (contentPages.length <= 1) {
          showSnackbar('Cannot delete last page');
        } else {
          captureSnapshot();
          page.remove();
          updatePageNumbers();
          renumberFootnotes();
          afterChange();
        }
      }
      return;
    }

    // Floating block actions
    if (target.closest('#block-actions') && target.dataset.action) {
      const action = target.dataset.action;
      if (action === 'move-up') moveBlocks('up');
      else if (action === 'move-down') moveBlocks('down');
      else if (action === 'duplicate') duplicateBlocks();
      else if (action === 'copy') copySelectedBlocks(false);
      else if (action === 'cut') copySelectedBlocks(true);
      else if (action === 'paste') pasteBlocksAfterSelection();
      else if (action === 'delete') deleteBlocks();
      return;
    }

    // Text toolbar clicks (formatting)
    if (target.closest('#text-toolbar')) {
      const cmdBtn = target.closest('[data-cmd]');
      const actionBtn = target.closest('[data-action]');
      if (cmdBtn && cmdBtn.dataset.cmd) {
        applyInlineCmd(cmdBtn.dataset.cmd);
      } else if (actionBtn) {
        if (actionBtn.dataset.action === 'highlight') {
          toggleHighlight();
        } else if (actionBtn.dataset.action === 'link') {
          const input = document.getElementById('link-input');
          if (input) input.focus();
        } else if (actionBtn.dataset.action === 'unlink') {
          removeLink();
        }
      }
      e.stopPropagation();
      return;
    }

    // Click inside editor body
    if (isInEditor(target)) {
      const block = target.closest('[data-deletable="true"]');
      const inMenu = target.closest('#block-actions');
      if (block && !block.closest('.footnotes-page') && !inMenu) {
        if (e.metaKey || e.ctrlKey) {
          block.classList.toggle('block-selected');
        } else {
          clearBlockSelection();
          block.classList.add('block-selected');
        }
        showBlockActions();
      } else if (!inMenu && !target.closest('#text-toolbar')) {
        clearBlockSelection();
      }
    } else if (!target.closest('#block-actions') && !target.closest('#text-toolbar')) {
      clearBlockSelection();
      hideTextToolbar();
    }
  });

  /* -------- Toolbar inputs -------- */

  document.getElementById('paragraph-style').addEventListener('change', function() {
    if (this.value) applyParagraphStyle(this.value);
    this.value = '';
  });

  document.getElementById('link-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      createLink(e.target.value.trim());
    } else if (e.key === 'Escape') {
      hideTextToolbar();
    }
  });

  document.addEventListener('mouseup', () => setTimeout(updateTextToolbar, 10));
  document.addEventListener('keyup', () => setTimeout(updateTextToolbar, 10));

  /* -------- Input handler (CTA + footnotes) -------- */

  editorRoot.addEventListener('input', e => {
    const target = e.target;

    // Track custom CTA title vs auto label
    if (target.classList && target.classList.contains('cta-title')) {
      const box = target.closest('.cta-box');
      if (box && target.textContent.trim() !== (box.dataset.generatedTitle || '').trim()) {
        box.dataset.customTitle = 'true';
      }
    }

    // Edits inside Footnotes page: keep references tidy
    if (target.closest && target.closest('.footnotes-page')) {
      renumberFootnotes();
    }

    scheduleInputSnapshot();
  });

  editorRoot.addEventListener('paste', handlePaste);

  /* -------- Top toolbar buttons -------- */

  document.querySelector('[data-add-page]').addEventListener('click', addPage);
  document.querySelector('[data-add-footnote]').addEventListener('click', addFootnote);

  document.getElementById('theme-select').addEventListener('change', function() {
    captureSnapshot();
    setTheme(this.value === 'ft' ? 'ft' : 'iga');
    afterChange();
  });

  document.getElementById('toggle-overlay').addEventListener('click', () => {
    document.body.classList.toggle('show-overlay');
  });

  document.getElementById('undo-btn').addEventListener('click', undo);
  document.getElementById('redo-btn').addEventListener('click', redo);
  document.getElementById('export-json').addEventListener('click', exportJSON);
  document.getElementById('import-json').addEventListener('click', () => jsonInput.click());
  document.getElementById('print-btn').addEventListener('click', () => window.print());

  jsonInput.addEventListener('change', function() {
    const file = this.files[0];
    if (file) importJSONFromFile(file);
    this.value = '';
  });

  document.querySelectorAll('[data-add]').forEach(btn => {
    btn.addEventListener('click', () => {
      const type = btn.dataset.add;
      if (type === 'section') addSectionBlock();
      else if (type === 'text') addTextBlock();
      else if (type === 'cta') addCtaBlock();
      else if (type === 'steps') addStepsBlock();
      else if (type === 'faq') addFaqBlock();
      else if (type === 'quote') addQuoteBlock();
      else if (type === 'divider') addDividerBlock();
      else if (type === 'citation') addCitationBlock();
      else if (type === 'table-glance') addAtAGlanceTable();
      else if (type === 'table-bai') addBAITable();
      else if (type === 'table-custom') openCustomTableModal();
      else if (type === 'image') openImageModal();
    });
  });

  document.addEventListener('keydown', e => {
    if ((e.metaKey || e.ctrlKey) && !e.shiftKey && e.key.toLowerCase() === 'z') {
      e.preventDefault();
      undo();
    } else if (
      (e.metaKey || e.ctrlKey) &&
      ((e.shiftKey && e.key.toLowerCase() === 'z') || e.key.toLowerCase() === 'y')
    ) {
      e.preventDefault();
      redo();
    }
  });

  /* -------- Initialisation -------- */

  ensureFootnotesPage();
  updatePageNumbers();
  renumberFootnotes();
  initAllTableResizers();
  initHistory();
})();
</script>
</body>
</html>
```
