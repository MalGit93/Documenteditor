<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IGA Executive Brief Designer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Optional fonts (non-blocking) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Source+Serif+4:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --page-width: 210mm;
      --page-height: 297mm;
      --page-margin: 12mm;
      --ui-font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --transition-fast: 0.16s ease-out;
      --border-radius-sm: 4px;
      --border-radius-md: 6px;
      --shadow-soft: 0 4px 14px rgba(0,0,0,0.10);
      --shadow-soft-strong: 0 8px 26px rgba(0,0,0,0.12);

      /* Defaults (overridden by theme) */
      --font-body: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --font-serif: "Source Serif 4", "Georgia", "Times New Roman", serif;

      --page-bg: #ffffff;
      --page-border: #d6dce5;
      --page-footer-color: #888;

      --text-color: #111827;
      --muted-text: #6b7280;
      --link-color: #1d4ed8;

      --accent-primary: #004f9e;
      --accent-secondary: #fb923c;

      --cta-blue-bg: #e5f1ff;
      --cta-blue-border: #1d4ed8;
      --cta-green-bg: #e6f7ed;
      --cta-green-border: #16a34a;
      --cta-yellow-bg: #fff7e5;
      --cta-yellow-border: #f59e0b;
      --cta-red-bg: #fee2e2;
      --cta-red-border: #dc2626;

      --divider-color: #e5e7eb;
      --table-border: #d1d5db;
      --table-header-bg: #f3f4f6;

      --highlight-bg: #fff3b0;

      --snackbar-bg: rgba(17,24,39,0.96);
      --snackbar-color: #f9fafb;

      /* Shared block background tokens */
      --block-bg-soft: rgba(249,250,251,0.96);
      --block-bg-softer: rgba(249,250,251,0.9);
      --quote-bg: rgba(249,250,251,0.9);
      --table-bg: rgba(249,250,251,0.96);
      --image-bg: rgba(249,250,251,0.96);
      --cta-label-color: #374151;
    }

    /* IGA THEME */
    body.theme-iga {
      --font-body: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

      --page-bg: #ffffff;
      --page-border: #d6dce5;
      --page-footer-color: #6b7280;
      --text-color: #111827;
      --muted-text: #6b7280;
      --link-color: #1d4ed8;

      --accent-primary: #004f9e;
      --accent-secondary: #fb923c;

      --cta-blue-bg: #e5f1ff;
      --cta-blue-border: #1d4ed8;
      --cta-green-bg: #e6f7ed;
      --cta-green-border: #16a34a;
      --cta-yellow-bg: #fff7e5;
      --cta-yellow-border: #d97706;
      --cta-red-bg: #fee2e2;
      --cta-red-border: #b91c1c;

      --divider-color: #e5e7eb;
      --table-border: #d1d5db;
      --table-header-bg: #f3f4f6;

      --highlight-bg: #fff3b0;

      --block-bg-soft: rgba(249,250,251,0.96);
      --block-bg-softer: rgba(249,250,251,0.9);
      --quote-bg: rgba(249,250,251,0.9);
      --table-bg: rgba(249,250,251,0.96);
      --image-bg: rgba(249,250,251,0.96);
      --cta-label-color: #374151;
    }

    /* FT-STYLE THEME */
    body.theme-ft {
      --font-body: "Source Serif 4", "Georgia", "Times New Roman", serif;
      --ui-font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

      --page-bg: #f6e7dc; /* warm newsprint */
      --page-border: #d9b8a3;
      --page-footer-color: #7b6a5a;
      --text-color: #2b2119;
      --muted-text: #8b7a6a;
      --link-color: #005f6b;

      --accent-primary: #b05f3c;
      --accent-secondary: #c89a5b;

      --cta-blue-bg: #f0e3d8;
      --cta-blue-border: #8b7a6a;
      --cta-green-bg: #e6f0e6;
      --cta-green-border: #5b8a5b;
      --cta-yellow-bg: #f7ebd2;
      --cta-yellow-border: #c89a5b;
      --cta-red-bg: #f6d6d6;
      --cta-red-border: #b05f3c;

      --divider-color: #d3bda8;
      --table-border: #c7aa91;
      --table-header-bg: #e8cfb9;

      --highlight-bg: #fdf0c2;
      --snackbar-bg: rgba(32,24,19,0.98);
      --snackbar-color: #fff7ec;

      --block-bg-soft: #f9eee4;
      --block-bg-softer: #f7e5d8;
      --quote-bg: #f8e9dd;
      --table-bg: #f9eee4;
      --image-bg: #f9eee4;
      --cta-label-color: #5c4a3d;
    }

    /* Global layout */
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: var(--text-color);
      font-family: var(--font-body);
      -webkit-font-smoothing: antialiased;
    }

    #app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Top toolbar */
    #app-header {
      position: sticky;
      top: 0;
      z-index: 40;
      padding: 8px 16px;
      background: rgba(17,24,39,0.96);
      color: #e5e7eb;
      display: flex;
      flex-wrap: wrap;
      gap: 10px 24px;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.35);
      font-family: var(--ui-font);
    }

    #app-title {
      font-weight: 600;
      letter-spacing: 0.02em;
      font-size: 14px;
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin-right: 18px;
      color: #f9fafb;
    }

    #app-title span.sub {
      font-weight: 400;
      font-size: 11px;
      color: #9ca3af;
    }

    .toolbar-group {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .toolbar-label {
      font-size: 10px;
      text-transform: uppercase;
      color: #9ca3af;
      margin-right: 4px;
    }

    button,
    select {
      font-family: var(--ui-font);
      font-size: 11px;
    }

    .toolbar-btn {
      padding: 4px 8px;
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(156,163,175,0.6);
      background: rgba(17,24,39,0.85);
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .toolbar-btn:hover {
      background: #111827;
      border-color: #f97316;
      color: #f9fafb;
      box-shadow: 0 0 0 1px rgba(249,115,22,0.18);
      transform: translateY(-0.5px);
    }

    .toolbar-btn.primary {
      border-color: #f97316;
      color: #fed7aa;
    }

    .toolbar-btn.danger {
      border-color: #b91c1c;
      color: #fecaca;
    }

    .toolbar-btn-icon {
      font-size: 12px;
    }

    #theme-select {
      padding: 3px 6px;
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(156,163,175,0.7);
      background: #111827;
      color: #e5e7eb;
      outline: none;
      cursor: pointer;
    }

    #editor-root-wrapper {
      flex: 1;
      overflow-y: auto;
      padding: 16px 0 32px;
    }

    #editor-root {
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }

    /* Page containers */
    .page-container {
      position: relative;
      width: 100%;
      max-width: calc(var(--page-width) * 0.8);
      background: var(--page-bg);
      color: var(--text-color);
      border: 1px solid var(--page-border);
      border-radius: 6px;
      box-shadow: var(--shadow-soft);
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 900px;
      overflow: hidden;
    }

    .page-body {
      padding: var(--page-margin);
      padding-bottom: 28px;
      flex: 1;
      position: relative;
    }

    .overflow-indicator {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 18px;
      display: none;
      align-items: center;
      gap: 8px;
      pointer-events: none;
      font-family: var(--ui-font);
      justify-content: center;
    }

    .overflow-indicator::before,
    .overflow-indicator::after {
      content: '';
      flex: 1;
      border-top: 2px dashed rgba(220,38,38,0.85);
    }

    .overflow-indicator span {
      pointer-events: auto;
      background: rgba(220,38,38,0.9);
      color: #fff;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      box-shadow: 0 2px 6px rgba(220,38,38,0.25);
    }

    .page-body[data-overflow="true"] .overflow-indicator {
      display: flex;
    }

    .page-footer {
      padding: 6px 10px;
      font-size: 10px;
      color: var(--page-footer-color);
      text-align: right;
      border-top: 1px solid var(--page-border);
      background: rgba(0,0,0,0.02);
      font-family: var(--ui-font);
    }

    /* Page controls */
    .page-controls {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 10;
      font-family: var(--ui-font);
    }

    .page-control-btn {
      width: 22px;
      height: 22px;
      padding: 0;
      border-radius: 999px;
      border: 1px solid rgba(148,163,253,0.3);
      background: rgba(17,24,39,0.88);
      color: #e5e7eb;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.35);
      transition: all var(--transition-fast);
    }

    .page-control-btn:hover {
      background: #111827;
      border-color: #f97316;
      color: #fed7aa;
      transform: translateY(-1px);
    }

    .footnotes-page .page-controls {
      display: none;
    }

    /* Overlay grid */
    .page-overlay {
      pointer-events: none;
      position: absolute;
      inset: var(--page-margin);
      border: 1px dashed rgba(148,163,253,0.4);
      border-radius: 2px;
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    body.show-overlay .page-overlay {
      opacity: 1;
    }

    /* Block selection */
    [data-deletable="true"] {
      position: relative;
      cursor: text;
    }

    .block-selected {
      outline: 2px solid #f97316;
      outline-offset: 1px;
      background-image: linear-gradient(to right, rgba(249,115,22,0.05), transparent);
    }

    .delete-icon {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      font-size: 11px;
      line-height: 16px;
      text-align: center;
      cursor: pointer;
      background: rgba(17,24,39,0.9);
      color: #fee2e2;
      display: none;
      user-select: none;
    }

    [data-deletable="true"]:hover > .delete-icon,
    .delete-icon:focus {
      display: block;
    }

    .delete-icon:focus-visible {
      outline: 2px solid #f97316;
      outline-offset: 2px;
    }

    /* Typographic scale */
    .doc-title {
      font-size: 26px;
      font-weight: 600;
      margin: 0 0 6px;
    }

    .doc-subtitle {
      font-size: 14px;
      color: var(--muted-text);
      margin: 0 0 14px;
    }

    .section-heading {
      font-size: 16px;
      font-weight: 600;
      margin: 16px 0 4px;
      padding-bottom: 2px;
      border-bottom: 2px solid var(--accent-primary);
    }

    .body-text {
      font-size: 12px;
      line-height: 1.6;
      margin: 6px 0;
    }

    .caption-text {
      font-size: 10px;
      color: var(--muted-text);
      margin-top: 2px;
    }

    .footnote-ref {
      font-size: 10px;
      vertical-align: super;
      cursor: pointer;
      color: var(--accent-primary);
    }

    a {
      color: var(--link-color);
      text-decoration: underline;
    }

    .text-highlight {
      background: var(--highlight-bg);
    }

    /* CTA / Info Box */
    .cta-box {
      margin: 10px 0;
      padding: 8px 10px 8px;
      border-radius: var(--border-radius-md);
      border-left: 4px solid var(--cta-blue-border);
      background: var(--cta-blue-bg);
      font-size: 11px;
      position: relative;
    }

    .cta-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .cta-body {
      font-size: 11px;
    }

    .cta-type-switch {
      display: inline-flex;
      gap: 4px;
      margin-bottom: 4px;
      font-family: var(--ui-font);
    }

    .cta-type-switch button {
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      font-size: 9px;
      cursor: pointer;
      color: var(--cta-label-color);
    }

    .cta-type-switch button.active {
      border-color: var(--cta-blue-border);
      background: rgba(17,24,39,0.04);
      color: #111827;
    }

    .cta-green {
      border-left-color: var(--cta-green-border);
      background: var(--cta-green-bg);
    }

    .cta-yellow {
      border-left-color: var(--cta-yellow-border);
      background: var(--cta-yellow-bg);
    }

    .cta-red {
      border-left-color: var(--cta-red-border);
      background: var(--cta-red-bg);
    }

    /* Steps */
    .steps-block {
      margin: 10px 0;
      padding: 8px 10px;
      border-radius: var(--border-radius-md);
      border: 1px solid var(--divider-color);
      background: var(--block-bg-soft);
      font-size: 11px;
    }

    .steps-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .styled-steps {
      padding-left: 16px;
      margin: 4px 0 4px;
    }

    .styled-steps li {
      margin: 2px 0;
    }

    .steps-add {
      border: none;
      background: transparent;
      color: var(--accent-primary);
      cursor: pointer;
      font-size: 10px;
      padding: 2px 0;
    }

    /* FAQ */
    .faq-block {
      margin: 10px 0;
      padding: 8px 10px;
      border-radius: var(--border-radius-md);
      border: 1px solid var(--divider-color);
      background: var(--block-bg-soft);
      font-size: 11px;
    }

    .faq-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .faq-list {
      padding-left: 14px;
      margin: 4px 0;
    }

    .faq-q {
      font-weight: 600;
    }

    .faq-a {
      margin-left: 4px;
    }

    .faq-add {
      border: none;
      background: transparent;
      color: var(--accent-primary);
      cursor: pointer;
      font-size: 10px;
      padding: 2px 0;
    }

    /* Quote */
    .quote-block {
      margin: 10px 0;
      padding: 8px 10px;
      border-left: 3px solid var(--accent-primary);
      background: var(--quote-bg);
      font-size: 11px;
      font-style: italic;
    }

    .quote-source {
      margin-top: 2px;
      font-size: 10px;
      font-style: normal;
      color: var(--muted-text);
    }

    /* Divider */
    .divider-block {
      margin: 10px 0;
      position: relative;
    }

    .section-divider {
      border: none;
      border-top: 1px solid var(--divider-color);
      margin: 4px 0;
    }

    /* Citation */
    .citation-block {
      font-size: 10px;
      color: var(--muted-text);
      font-style: italic;
      margin: 4px 0;
    }

    /* Tables */
    .table-block {
      margin: 10px 0;
      padding: 6px 6px 4px;
      border-radius: var(--border-radius-md);
      border: 1px solid var(--table-border);
      background: var(--table-bg);
      font-size: 10px;
      overflow-x: auto;
    }

    .iga-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
      table-layout: fixed;           /* keeps layout stable */
    }

    .iga-table th,
    .iga-table td {
      border: 1px solid var(--table-border);
      padding: 4px 4px;
      vertical-align: top;
      position: relative;
      word-wrap: break-word;
      overflow-wrap: break-word;     /* avoid ugly overflow */
    }

    .iga-table th {
      background: var(--table-header-bg);
      font-weight: 600;
    }

    .table-controls {
      display: flex;
      gap: 4px;
      margin: 4px 0 0;
      font-family: var(--ui-font);
    }

    .table-controls button {
      border: none;
      background: transparent;
      font-size: 9px;
      cursor: pointer;
      color: var(--accent-primary);
      padding: 1px 4px;
      border-radius: 999px;
    }

    .table-controls button:hover {
      background: rgba(17,24,39,0.04);
    }

    /* Column resize handle */
    .col-resize-handle {
      position: absolute;
      top: 0;
      right: -3px;
      width: 6px;
      height: 100%;
      cursor: col-resize;
      user-select: none;
      z-index: 5;
    }

    /* Images */
    .image-block {
      margin: 10px 0;
      padding: 4px 4px 2px;
      border-radius: var(--border-radius-md);
      border: 1px solid var(--divider-color);
      background: var(--image-bg);
      text-align: center;
      font-size: 10px;
    }

    .image-size-controls {
      display: inline-flex;
      gap: 2px;
      margin-bottom: 4px;
      font-family: var(--ui-font);
    }

    .image-size-controls button {
      border: none;
      background: transparent;
      font-size: 9px;
      padding: 1px 4px;
      border-radius: 999px;
      cursor: pointer;
      color: #6b7280;
    }

    .image-size-controls button.active {
      background: rgba(17,24,39,0.08);
      color: #111827;
    }

    .image-block img {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      max-height: 260px;
      object-fit: contain;
    }

    .image-size-s img { max-width: 40%; }
    .image-size-m img { max-width: 65%; }
    .image-size-l img { max-width: 100%; }

    .image-caption {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted-text);
      text-align: center;
    }

    /* Footnotes page */
    .footnotes-page .page-body {
      padding-top: 18px;
    }

    .footnotes-page h3.section-heading {
      margin-top: 0;
    }

    #footnote-list {
      font-size: 11px;
      margin-top: 4px;
      padding-left: 16px;
    }

    #footnote-list li {
      margin: 2px 0;
      line-height: 1.5;
    }

    .footnote-target {
      display: inline;
    }

    .footnote-target .footnote-ref {
      margin-left: 2px;
    }

    .footnote-return {
      margin-left: 6px;
      border: none;
      background: none;
      color: var(--accent-primary);
      cursor: pointer;
      font-size: 10px;
      padding: 0 4px;
    }

    .footnote-return:focus-visible,
    .footnote-return:hover {
      color: var(--accent-secondary);
      outline: 1px solid var(--accent-primary);
      outline-offset: 1px;
    }

    .footnote-highlight {
      animation: footnoteFlash 1.2s ease-in-out;
    }

    @keyframes footnoteFlash {
      0% { background: rgba(59,130,246,0.25); }
      100% { background: transparent; }
    }

    /* Floating block actions menu */
    .floating-menu {
      position: absolute;
      z-index: 60;
      padding: 4px;
      border-radius: var(--border-radius-md);
      background: rgba(17,24,39,0.98);
      color: #e5e7eb;
      box-shadow: var(--shadow-soft-strong);
      display: flex;
      gap: 2px;
      align-items: center;
      font-family: var(--ui-font);
      font-size: 10px;
      transform: translate(-50%, -110%);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-fast), transform var(--transition-fast);
    }

    .floating-menu.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -120%);
    }

    .floating-menu button {
      border: none;
      background: transparent;
      color: inherit;
      padding: 2px 4px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 10px;
    }

    .floating-menu button:hover {
      background: rgba(249,115,22,0.14);
      color: #fed7aa;
    }

    /* Text selection toolbar */
    #text-toolbar {
      position: absolute;
      z-index: 70;
      padding: 3px 4px;
      background: rgba(17,24,39,0.98);
      color: #e5e7eb;
      border-radius: var(--border-radius-md);
      display: flex;
      align-items: center;
      gap: 2px;
      box-shadow: var(--shadow-soft-strong);
      opacity: 0;
      pointer-events: none;
      transform: translate(-50%, -120%);
      font-family: var(--ui-font);
      font-size: 10px;
    }

    #text-toolbar.visible {
      opacity: 1;
      pointer-events: auto;
    }

    #text-toolbar button {
      border: none;
      background: transparent;
      color: inherit;
      padding: 2px 4px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 10px;
    }

    #text-toolbar button:hover {
      background: rgba(249,115,22,0.16);
      color: #fed7aa;
    }

    #paragraph-style {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 9px;
      padding: 1px 2px;
      cursor: pointer;
    }

    #link-input {
      width: 120px;
      border-radius: 3px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      font-size: 9px;
      padding: 1px 4px;
      outline: none;
    }

    /* Snackbar */
    #snackbar {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: var(--snackbar-bg);
      color: var(--snackbar-color);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 11px;
      font-family: var(--ui-font);
      box-shadow: 0 6px 20px rgba(0,0,0,0.45);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease-out, transform 0.18s ease-out;
      z-index: 90;
      max-width: 80vw;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #snackbar.show {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -4px);
    }

    /* Modals */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 80;
    }

    .modal-backdrop.visible {
      display: flex;
    }

    .modal-inner {
      background: #0f172a;
      padding: 12px 12px 10px;
      border-radius: 8px;
      box-shadow: 0 8px 26px rgba(0,0,0,0.6);
      color: #e5e7eb;
      width: 260px;
      font-family: var(--ui-font);
      font-size: 11px;
    }

    .modal-inner h3 {
      margin: 0 0 6px;
      font-size: 12px;
      font-weight: 600;
      color: #f97316;
    }

    .modal-inner label {
      display: block;
      margin: 4px 0 2px;
      font-size: 10px;
      color: #9ca3af;
    }

    .modal-inner input,
    .modal-inner textarea {
      width: 100%;
      border-radius: 4px;
      border: 1px solid #4b5563;
      padding: 4px;
      font-size: 10px;
      background: #020817;
      color: #e5e7eb;
      margin-bottom: 4px;
      outline: none;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 4px;
      margin-top: 2px;
    }

    .modal-actions button {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #6b7280;
      background: transparent;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 10px;
    }

    .modal-actions button.primary {
      border-color: #f97316;
      color: #fed7aa;
    }

    .modal-actions button:hover {
      background: rgba(15,23,42,0.86);
    }

    @page {
      size: A4;
      margin: 0;
    }

    /* Print styles */
    @media print {
      html,
      body {
        margin: 0;
        padding: 0;
        background: var(--page-bg);
      }

      #app-header,
      #block-actions,
      #text-toolbar,
      #snackbar,
      .page-controls,
      .page-overlay,
      .modal-backdrop {
        display: none !important;
      }

      #editor-root-wrapper {
        padding: 0 !important;
        background: var(--page-bg);
      }

      #editor-root {
        margin: 0;
        width: auto;
        align-items: stretch;
      }

      .page-container {
        box-shadow: none;
        border: none;
        border-radius: 0;
        width: 100%;
        max-width: none;
        min-height: auto;
        page-break-after: always;
        background: var(--page-bg);
      }

      .page-body {
        padding: var(--page-margin);
      }

      .page-break-avoider {
        break-inside: avoid;
        page-break-inside: avoid;
      }

      [data-deletable="true"] .delete-icon {
        display: none !important;
      }
    }
  </style>
</head>
<body class="theme-iga">
<div id="app">
  <header id="app-header">
    <div id="app-title">
      <span>IGA Executive Brief Designer</span>
      <span class="sub">Single-file themed WYSIWYG</span>
    </div>

    <div class="toolbar-group">
      <span class="toolbar-label">Pages</span>
      <button class="toolbar-btn primary" data-add-page aria-label="Add page"><span class="toolbar-btn-icon">ï¼‹</span>Page</button>
      <button class="toolbar-btn" data-add-footnote aria-label="Add footnote">+ Footnote</button>
    </div>

    <div class="toolbar-group">
      <span class="toolbar-label">Insert block</span>
      <button class="toolbar-btn" data-add="section" aria-label="Insert section">Section</button>
      <button class="toolbar-btn" data-add="text" aria-label="Insert text block">Text</button>
      <button class="toolbar-btn" data-add="cta" aria-label="Insert info box">Info box</button>
      <button class="toolbar-btn" data-add="steps" aria-label="Insert steps block">Steps</button>
      <button class="toolbar-btn" data-add="faq" aria-label="Insert FAQ block">FAQ</button>
      <button class="toolbar-btn" data-add="quote" aria-label="Insert quote block">Quote</button>
      <button class="toolbar-btn" data-add="divider" aria-label="Insert divider">Divider</button>
      <button class="toolbar-btn" data-add="citation" aria-label="Insert citation">Citation</button>
      <button class="toolbar-btn" data-add="table-glance" aria-label="Insert at-a-glance table">At-a-glance</button>
      <button class="toolbar-btn" data-add="table-bai" aria-label="Insert before after impact table">Before/After/Impact</button>
      <button class="toolbar-btn" data-add="table-custom" aria-label="Insert custom table">Custom table</button>
      <button class="toolbar-btn" data-add="image" aria-label="Insert image">Image</button>
    </div>

    <div class="toolbar-group">
      <span class="toolbar-label">Layouts</span>
      <button class="toolbar-btn" data-template="iga-brief" aria-label="Use IGA executive brief template">IGA Brief</button>
      <button class="toolbar-btn" data-template="ft-explainer" aria-label="Use FT-style explainer template">FT Explainer</button>
    </div>

    <div class="toolbar-group">
      <span class="toolbar-label">Theme</span>
      <select id="theme-select" aria-label="Select theme">
        <option value="iga">IGA</option>
        <option value="ft">FT-style</option>
      </select>
      <button class="toolbar-btn" id="toggle-overlay" aria-label="Toggle layout grid">Grid</button>
    </div>

    <div class="toolbar-group">
      <span class="toolbar-label">Edit</span>
      <button class="toolbar-btn" id="undo-btn" aria-label="Undo">Undo</button>
      <button class="toolbar-btn" id="redo-btn" aria-label="Redo">Redo</button>
      <button class="toolbar-btn" id="quality-check-btn" aria-label="Check brief for placeholders" title="Check brief for placeholders">Check brief</button>
      <button class="toolbar-btn" id="export-json" aria-label="Export JSON">Export JSON</button>
      <button class="toolbar-btn" id="import-json" aria-label="Import JSON">Import JSON</button>
      <button class="toolbar-btn" id="print-btn" aria-label="Print or save as PDF">Print / PDF</button>
    </div>

    <div class="toolbar-group">
      <button class="toolbar-btn" id="help-btn" aria-label="Show help" title="Show help">?</button>
    </div>
  </header>

  <div id="editor-root-wrapper">
    <main id="editor-root">
      <!-- Initial content page -->
      <div class="page-container" data-page-type="content">
        <div class="page-controls">
          <button class="page-control-btn" data-move-page-up title="Move page up" aria-label="Move page up">â†‘</button>
          <button class="page-control-btn" data-move-page-down title="Move page down" aria-label="Move page down">â†“</button>
          <button class="page-control-btn" data-dup-page title="Duplicate page" aria-label="Duplicate page">â§‰</button>
          <button class="page-control-btn" data-del-page title="Delete page" aria-label="Delete page">âœ•</button>
        </div>
        <div class="page-overlay"></div>
        <div class="page-body">
          <div class="doc-title" data-deletable="true" contenteditable="true">
            Executive Brief Title
            <span class="delete-icon" contenteditable="false" role="button" tabindex="0" aria-label="Delete block">Ã—</span>
          </div>
          <p class="doc-subtitle body-text" data-deletable="true" contenteditable="true">
            Short positioning subtitle / context line.
            <span class="delete-icon" contenteditable="false" role="button" tabindex="0" aria-label="Delete block">Ã—</span>
          </p>
          <h3 class="section-heading" data-deletable="true">
            <span contenteditable="true">Key messages</span>
            <span class="delete-icon" contenteditable="false" role="button" tabindex="0" aria-label="Delete block">Ã—</span>
          </h3>
          <p class="body-text" data-deletable="true" contenteditable="true">
            Use this space to summarise the essentials in clear, direct language aligned with IGA style.
            <span class="delete-icon" contenteditable="false" role="button" tabindex="0" aria-label="Delete block">Ã—</span>
          </p>
          <div class="overflow-indicator" aria-hidden="true">
            <span title="Consider splitting page" aria-label="Consider splitting page">!</span>
          </div>
        </div>
        <div class="page-footer">Page 1</div>
      </div>

      <!-- Footnotes page (always last) -->
      <div class="page-container footnotes-page" data-page-type="footnotes">
        <div class="page-overlay"></div>
        <div class="page-body">
          <h3 class="section-heading">
            <span contenteditable="false">Footnotes</span>
          </h3>
          <ol id="footnote-list"></ol>
        </div>
        <div class="page-footer">Footnotes</div>
      </div>
    </main>
  </div>
</div>

<!-- Floating block actions menu -->
<div id="block-actions" class="floating-menu">
  <button data-action="move-up" title="Move block up" aria-label="Move block up">â†‘</button>
  <button data-action="move-down" title="Move block down" aria-label="Move block down">â†“</button>
  <button data-action="duplicate" title="Duplicate block(s)" aria-label="Duplicate blocks">â§‰</button>
  <button data-action="copy" title="Copy block(s)" aria-label="Copy blocks">â§„</button>
  <button data-action="cut" title="Cut block(s)" aria-label="Cut blocks">âœ‚</button>
  <button data-action="paste" title="Paste after selection" aria-label="Paste blocks">â§ </button>
  <button data-action="move-to-page" title="Move selection to new page" aria-label="Move selection to new page">â‡¢</button>
  <button data-action="delete" title="Delete block(s)" aria-label="Delete blocks">âœ•</button>
</div>

<!-- Floating text formatting toolbar -->
<div id="text-toolbar">
  <button data-cmd="bold"><b>B</b></button>
  <button data-cmd="italic"><i>I</i></button>
  <button data-cmd="underline"><u>U</u></button>
  <button data-action="highlight">HL</button>
  <select id="paragraph-style">
    <option value="">Â¶</option>
    <option value="h1">H1</option>
    <option value="h2">H2</option>
    <option value="h3">H3</option>
    <option value="p">Body</option>
  </select>
  <button data-action="link">ðŸ”—</button>
  <button data-action="unlink">âœ•</button>
  <input type="url" id="link-input" placeholder="URL" />
</div>

<!-- Snackbar -->
<div id="snackbar"></div>

<!-- Modals -->
<div id="modal-backdrop" class="modal-backdrop">
  <div class="modal-inner" id="modal-inner"></div>
</div>

<!-- Hidden JSON input -->
<input type="file" id="json-file-input" accept="application/json" style="display:none" />

<script>
(function() {
  const editorRoot = document.getElementById('editor-root');
  const blockActions = document.getElementById('block-actions');
  const textToolbar = document.getElementById('text-toolbar');
  const snackbar = document.getElementById('snackbar');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const modalInner = document.getElementById('modal-inner');
  const jsonInput = document.getElementById('json-file-input');

  const DELETE_ICON_HTML = '<span class="delete-icon" contenteditable="false" role="button" tabindex="0" aria-label="Delete block">Ã—</span>';
  const DRAFT_STORAGE_KEY = 'igaEbdDraft';
  const QUALITY_PLACEHOLDERS = [
    'New paragraphâ€¦',
    'Step 1â€¦',
    'Step 2â€¦',
    'Step 3â€¦',
    'Q: â€¦',
    'A: â€¦',
    'Current stateâ€¦',
    'Target stateâ€¦',
    'Outcome / benefitâ€¦',
    'Who this is forâ€¦',
    'What we need them to doâ€¦',
    'Key datesâ€¦',
    'Add an explanatory captionâ€¦',
    'Your footnote text here.'
  ];

  const INTERNAL_MARKER_START = '<!--EBD_INTERNAL_START-->';
  const INTERNAL_MARKER_END = '<!--EBD_INTERNAL_END-->';

  let internalClipboardHTML = '';
  let currentTextRange = null;

  let undoStack = [];
  let redoStack = [];
  let lastSerialized = null;
  let inputSnapshotTimer = null;
  let suppressSnapshots = false;

  // For column resizing
  let tableResizeState = null;

  function persistDraft(serialized) {
    try {
      localStorage.setItem(DRAFT_STORAGE_KEY, serialized);
    } catch (err) {
      /* noop */
    }
  }

  function loadDraft() {
    try {
      return localStorage.getItem(DRAFT_STORAGE_KEY);
    } catch (err) {
      return null;
    }
  }

  function clearDraft() {
    try {
      localStorage.removeItem(DRAFT_STORAGE_KEY);
    } catch (err) {
      /* noop */
    }
  }

  function promptRestoreDraft() {
    const saved = loadDraft();
    if (!saved) return;
    if (lastSerialized && saved === lastSerialized) return;
    openModal({
      title: 'Restore draft?',
      body: '<p>We found a saved draft from your last session. Restore it?</p>',
      confirmLabel: 'Restore',
      cancelLabel: 'Discard',
      onConfirm: () => {
        closeModal();
        applyState(saved);
        showSnackbar('Draft restored');
      },
      onCancel: () => {
        clearDraft();
        closeModal();
      }
    });
  }

  function getCurrentTheme() {
    return document.body.classList.contains('theme-ft') ? 'ft' : 'iga';
  }

  function setTheme(theme) {
    document.body.classList.remove('theme-iga', 'theme-ft');
    if (theme === 'ft') {
      document.body.classList.add('theme-ft');
      document.getElementById('theme-select').value = 'ft';
    } else {
      document.body.classList.add('theme-iga');
      document.getElementById('theme-select').value = 'iga';
    }
  }

  function ensureFootnotesPage() {
    let footnotes = editorRoot.querySelector('.footnotes-page');
    if (!footnotes) {
      footnotes = document.createElement('div');
      footnotes.className = 'page-container footnotes-page';
      footnotes.dataset.pageType = 'footnotes';
      footnotes.innerHTML = `
        <div class="page-overlay"></div>
        <div class="page-body">
          <h3 class="section-heading"><span contenteditable="false">Footnotes</span></h3>
          <ol id="footnote-list"></ol>
        </div>
        <div class="page-footer">Footnotes</div>
      `;
      editorRoot.appendChild(footnotes);
    } else {
      editorRoot.appendChild(footnotes);
    }

    // Ensure existing lis are editable after reload/import
    const list = footnotes.querySelector('#footnote-list');
    if (list) {
      list.querySelectorAll('li').forEach(li => {
        if (!li.hasAttribute('contenteditable')) {
          li.contentEditable = 'true';
        }
      });
    }
  }

  function updatePageNumbers() {
    const pages = editorRoot.querySelectorAll('.page-container');
    let pageIndex = 1;
    pages.forEach(page => {
      const footer = page.querySelector('.page-footer');
      if (!footer) return;
      if (page.classList.contains('footnotes-page')) {
        footer.textContent = 'Footnotes';
      } else {
        footer.textContent = 'Page ' + pageIndex;
        page.dataset.pageNumber = String(pageIndex);
        pageIndex++;
      }
    });
  }

  function showSnackbar(message, duration = 2000) {
    snackbar.textContent = message;
    snackbar.classList.add('show');
    setTimeout(() => snackbar.classList.remove('show'), duration);
  }

  function clearBlockSelection() {
    editorRoot.querySelectorAll('.block-selected').forEach(el => el.classList.remove('block-selected'));
    hideBlockActions();
  }

  function getSelectedBlocks() {
    return Array.from(editorRoot.querySelectorAll('.block-selected')).filter(el =>
      el.closest('.page-container') &&
      !el.closest('.footnotes-page') &&
      el.dataset.deletable === 'true'
    );
  }

  function getLastSelectedBlock() {
    const blocks = getSelectedBlocks();
    return blocks.length ? blocks[blocks.length - 1] : null;
  }

  function isInEditor(node) {
    return node && editorRoot.contains(node);
  }

  function getActiveContentPageBody() {
    const sel = window.getSelection();
    if (sel && sel.rangeCount) {
      const node = sel.anchorNode;
      if (node) {
        const el = node.nodeType === 1 ? node : node.parentElement;
        const page = el && el.closest('.page-container');
        if (page && !page.classList.contains('footnotes-page')) {
          return page.querySelector('.page-body');
        }
      }
    }
    const pages = editorRoot.querySelectorAll('.page-container:not(.footnotes-page)');
    const last = pages[pages.length - 1];
    return last ? last.querySelector('.page-body') : null;
  }

  function ensureBlockVisible(block) {
    if (!block) return;
    block.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function serializeState() {
    const theme = getCurrentTheme();
    clearBlockSelection();
    hideTextToolbar();
    hideBlockActions();
    const html = editorRoot.innerHTML;
    return JSON.stringify({ theme, html });
  }

  function checkPageOverflowState(pageBody) {
    if (!pageBody) return;
    const indicator = pageBody.querySelector('.overflow-indicator');
    if (!indicator) return;
    const contentHeight = pageBody.scrollHeight;
    const visibleHeight = pageBody.clientHeight;
    const delta = contentHeight - visibleHeight;
    const buffer = 48;
    const warn = delta > -buffer;
    if (warn) {
      pageBody.dataset.overflow = 'true';
      const pill = indicator.querySelector('span');
      if (pill) {
        const message = delta > 0
          ? 'Content exceeds page height. Consider splitting page.'
          : 'Content nearing page limit. Consider splitting page.';
        pill.title = message;
        pill.setAttribute('aria-label', message);
      }
    } else {
      pageBody.dataset.overflow = 'false';
    }
  }

  function checkAllPageOverflow() {
    editorRoot.querySelectorAll('.page-container:not(.footnotes-page) .page-body').forEach(checkPageOverflowState);
  }

  function captureSnapshot() {
    if (suppressSnapshots) return;
    if (lastSerialized === null) {
      lastSerialized = serializeState();
      return;
    }
    undoStack.push(lastSerialized);
    if (undoStack.length > 50) undoStack.shift();
    redoStack.length = 0;
  }

  function afterChange() {
    if (suppressSnapshots) return;
    lastSerialized = serializeState();
    checkAllPageOverflow();
    persistDraft(lastSerialized);
  }

  function applyState(serialized) {
    suppressSnapshots = true;
    try {
      const state = JSON.parse(serialized);
      setTheme(state.theme || 'iga');
      editorRoot.innerHTML = state.html || '';
      ensureFootnotesPage();
      updatePageNumbers();
      renumberFootnotes();
      initAllTableResizers();
      checkAllPageOverflow();
    } catch (e) {
      console.error(e);
      showSnackbar('Failed to apply state');
    }
    suppressSnapshots = false;
    lastSerialized = serialized;
    persistDraft(serialized);
  }

  function undo() {
    if (!undoStack.length) {
      showSnackbar('Nothing to undo');
      return;
    }
    const current = serializeState();
    const prev = undoStack.pop();
    redoStack.push(current);
    applyState(prev);
  }

  function redo() {
    if (!redoStack.length) {
      showSnackbar('Nothing to redo');
      return;
    }
    const current = serializeState();
    const next = redoStack.pop();
    undoStack.push(current);
    applyState(next);
  }

  function initHistory() {
    undoStack = [];
    redoStack = [];
    lastSerialized = serializeState();
    checkAllPageOverflow();
    persistDraft(lastSerialized);
  }

  /* -------- Footnotes: debounced auto-renumber + observer -------- */

  let footnoteMutationTimer = null;

  function scheduleFootnoteRenumber() {
    if (footnoteMutationTimer) return;
    footnoteMutationTimer = setTimeout(() => {
      renumberFootnotes();
      afterChange();
      footnoteMutationTimer = null;
    }, 80);
  }

  const footnoteObserver = new MutationObserver(mutations => {
    let changed = false;

    for (const m of mutations) {
      if (m.type !== 'childList') continue;

      // Look at removed nodes
      m.removedNodes.forEach(node => {
        if (node.nodeType !== 1) return;

        // If a footnote ref or footnote li itself was removed
        if (node.matches && (node.matches('.footnote-ref') || node.matches('#footnote-list li'))) {
          changed = true;
          return;
        }

        // Or if a container containing them was removed
        if (
          node.querySelector &&
          (node.querySelector('.footnote-ref') || node.querySelector('#footnote-list li'))
        ) {
          changed = true;
        }
      });

      // Direct removals from the footnote list
      if (!changed && m.target && m.target.id === 'footnote-list' && m.removedNodes.length) {
        changed = true;
      }
    }

    if (changed) {
      scheduleFootnoteRenumber();
    }
  });

  footnoteObserver.observe(editorRoot, {
    childList: true,
    subtree: true
  });

  /* -------- Block actions UI -------- */

  function positionBlockActions() {
    const last = getLastSelectedBlock();
    if (!last) {
      hideBlockActions();
      return;
    }
    const rect = last.getBoundingClientRect();
    blockActions.style.left = (rect.left + rect.width / 2 + window.scrollX) + 'px';
    blockActions.style.top = (rect.top + window.scrollY - 8) + 'px';
    blockActions.classList.add('visible');
  }

  function showBlockActions() {
    if (getSelectedBlocks().length) {
      positionBlockActions();
    } else {
      hideBlockActions();
    }
  }

  function hideBlockActions() {
    blockActions.classList.remove('visible');
  }

  /* -------- Text toolbar / selection -------- */

  function selectionWithinEditor() {
    const sel = window.getSelection();
    if (!sel || !sel.rangeCount) return false;
    const range = sel.getRangeAt(0);
    return isInEditor(range.commonAncestorContainer);
  }

  function isToolbarActiveElement() {
    const active = document.activeElement;
    return active && textToolbar.contains(active);
  }

  function updateTextToolbar() {
    if (!selectionWithinEditor()) {
      if (isToolbarActiveElement()) return;
      hideTextToolbar();
      return;
    }
    const sel = window.getSelection();
    if (sel.isCollapsed) {
      if (isToolbarActiveElement()) return;
      hideTextToolbar();
      return;
    }
    currentTextRange = sel.getRangeAt(0).cloneRange();
    const rect = currentTextRange.getBoundingClientRect();
    if (!rect || (!rect.width && !rect.height)) {
      hideTextToolbar();
      return;
    }
    textToolbar.style.left = (rect.left + rect.width / 2 + window.scrollX) + 'px';
    textToolbar.style.top = (rect.top + window.scrollY - 6) + 'px';
    textToolbar.classList.add('visible');
  }

  function hideTextToolbar() {
    textToolbar.classList.remove('visible');
    currentTextRange = null;
    const linkInput = document.getElementById('link-input');
    if (linkInput) linkInput.value = '';
  }

  function restoreSelection() {
    if (!currentTextRange) return;
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(currentTextRange);
  }

  function focusEditableFromRange(range) {
    if (!range) return;
    let node = range.startContainer;
    if (node && node.nodeType === Node.TEXT_NODE) {
      node = node.parentElement;
    }
    if (!node || !(node instanceof Element)) return;
    const editable = node.closest('[contenteditable="true"]');
    if (editable && typeof editable.focus === 'function') {
      try {
        editable.focus({ preventScroll: true });
      } catch (err) {
        editable.focus();
      }
    }
  }

  function execWithinSelection(callback, { hideToolbar = false } = {}) {
    if (!currentTextRange) return;
    focusEditableFromRange(currentTextRange);
    restoreSelection();
    callback();
    const sel = window.getSelection();
    if (sel && sel.rangeCount) {
      currentTextRange = sel.getRangeAt(0).cloneRange();
    } else {
      currentTextRange = null;
    }
    scheduleInputSnapshot();
    if (hideToolbar) hideTextToolbar();
    else updateTextToolbar();
  }

  function applyInlineCmd(cmd) {
    execWithinSelection(() => document.execCommand(cmd, false, null));
  }

  function toggleHighlight() {
    const command = document.queryCommandSupported('hiliteColor') ? 'hiliteColor' : 'backColor';
    execWithinSelection(() => {
      let currentValue = '';
      try {
        currentValue = document.queryCommandValue(command) || '';
      } catch (err) {
        currentValue = '';
      }
      const lower = typeof currentValue === 'string' ? currentValue.toLowerCase() : '';
      if (lower.includes('255') && lower.includes('243')) {
        document.execCommand(command, false, 'transparent');
      } else {
        document.execCommand(command, false, '#fff3b0');
      }
    }, { hideToolbar: true });
  }

  function applyParagraphStyle(style) {
    if (!currentTextRange) return;
    focusEditableFromRange(currentTextRange);
    restoreSelection();
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    let el = range.startContainer;
    if (el.nodeType === Node.TEXT_NODE) el = el.parentElement;
    if (!el) return;
    let block = el.closest('.body-text, .section-heading, h1, h2, h3, p, .doc-title, .doc-subtitle');
    if (!block) block = el;

    function transform(tagName, className) {
      if (block.tagName && block.tagName.toLowerCase() === tagName.toLowerCase()) {
        block.className = className;
        return;
      }
      const replacement = document.createElement(tagName);
      replacement.className = className;
      replacement.innerHTML = block.innerHTML;
      block.parentNode.replaceChild(replacement, block);
    }

    if (style === 'h1') transform('h1', 'doc-title');
    else if (style === 'h2') transform('h2', 'section-heading');
    else if (style === 'h3') transform('h3', 'section-heading');
    else if (style === 'p') transform('p', 'body-text');

    scheduleInputSnapshot();
    hideTextToolbar();
  }

  function createLink(url) {
    if (!currentTextRange) return;
    if (!url) {
      hideTextToolbar();
      return;
    }
    if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
    execWithinSelection(() => {
      document.execCommand('unlink');
      document.execCommand('createLink', false, url);
    }, { hideToolbar: true });
  }

  function removeLink() {
    if (!currentTextRange) return;
    execWithinSelection(() => document.execCommand('unlink'), { hideToolbar: true });
  }

  /* -------- Footnotes add + renumber -------- */

  function createFootnoteRefElement(id) {
    const sup = document.createElement('sup');
    sup.className = 'footnote-ref';
    sup.dataset.uniqueId = id;
    sup.contentEditable = 'false';
    sup.tabIndex = 0;
    sup.setAttribute('role', 'button');
    sup.setAttribute('aria-label', 'Jump to footnote');
    sup.textContent = '[?]';
    return sup;
  }

  function decorateFootnoteListItem(li, num) {
    if (!li) return;
    li.contentEditable = 'true';
    li.setAttribute('data-number', String(num));
    li.id = 'fn-note-' + num;
    let returnBtn = li.querySelector('.footnote-return');
    if (!returnBtn) {
      returnBtn = document.createElement('button');
      returnBtn.type = 'button';
      returnBtn.className = 'footnote-return';
      returnBtn.contentEditable = 'false';
      returnBtn.textContent = 'â†©';
      li.appendChild(returnBtn);
    }
    returnBtn.dataset.uniqueId = li.dataset.uniqueId;
    returnBtn.tabIndex = 0;
    returnBtn.setAttribute('aria-label', 'Jump to reference ' + num);
  }

  function cleanupOrphanFootnoteTargets() {
    editorRoot.querySelectorAll('.footnote-target').forEach(wrapper => {
      if (!wrapper.querySelector('.footnote-ref')) {
        while (wrapper.firstChild) {
          wrapper.parentNode.insertBefore(wrapper.firstChild, wrapper);
        }
        wrapper.remove();
      }
    });
  }

  function flashElement(el) {
    if (!el) return;
    el.classList.add('footnote-highlight');
    setTimeout(() => el.classList.remove('footnote-highlight'), 1200);
  }

  function scrollToFootnoteNote(uniqueId) {
    if (!uniqueId) return;
    const note = editorRoot.querySelector(`#footnote-list li[data-unique-id="${uniqueId}"]`);
    if (note) {
      note.scrollIntoView({ behavior: 'smooth', block: 'center' });
      flashElement(note);
      setTimeout(() => {
        try { note.focus(); } catch (err) { /* ignore */ }
      }, 200);
    }
  }

  function scrollToFootnoteRef(uniqueId) {
    if (!uniqueId) return;
    const ref = editorRoot.querySelector(`.footnote-ref[data-unique-id="${uniqueId}"]`);
    if (ref) {
      const wrapper = ref.closest('.footnote-target') || ref;
      wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
      flashElement(wrapper);
      const range = document.createRange();
      range.setStartAfter(ref);
      range.setEndAfter(ref);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      currentTextRange = range.cloneRange();
    }
  }

  function addFootnote() {
    const sel = window.getSelection();
    if (!sel || !sel.rangeCount) {
      showSnackbar('Place the caret in body content first');
      return;
    }
    const range = sel.getRangeAt(0);
    const container = range.commonAncestorContainer.nodeType === 1
      ? range.commonAncestorContainer
      : range.commonAncestorContainer.parentElement;
    const page = container && container.closest('.page-container');
    if (!page || page.classList.contains('footnotes-page')) {
      showSnackbar('Footnotes can only be added in body pages');
      return;
    }

    captureSnapshot();
    const id = 'fn-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 8);
    const sup = createFootnoteRefElement(id);
    let seedText = 'Your footnote text here.';
    if (!range.collapsed) {
      const fragment = range.cloneContents();
      const text = fragment.textContent ? fragment.textContent.replace(/\s+/g, ' ').trim() : '';
      if (text) seedText = text;
      const wrapper = document.createElement('span');
      wrapper.className = 'footnote-target';
      wrapper.dataset.uniqueId = id;
      wrapper.appendChild(range.extractContents());
      wrapper.appendChild(sup);
      range.insertNode(wrapper);
      const after = document.createRange();
      after.setStartAfter(wrapper);
      after.setEndAfter(wrapper);
      sel.removeAllRanges();
      sel.addRange(after);
    } else {
      range.collapse(false);
      range.insertNode(sup);
      const after = document.createRange();
      after.setStartAfter(sup);
      after.setEndAfter(sup);
      sel.removeAllRanges();
      sel.addRange(after);
    }

    const list = editorRoot.querySelector('.footnotes-page #footnote-list');
    const li = document.createElement('li');
    li.dataset.uniqueId = id;
    li.contentEditable = 'true';
    li.textContent = seedText;
    list.appendChild(li);

    renumberFootnotes();
    afterChange();
    flashElement(sup);
  }

  function renumberFootnotes() {
    const footnotesPage = editorRoot.querySelector('.footnotes-page');
    if (!footnotesPage) return;
    const list = footnotesPage.querySelector('#footnote-list');
    if (!list) return;

    // Collect all refs from content pages
    const refNodes = [];
    const contentPages = editorRoot.querySelectorAll('.page-container:not(.footnotes-page)');
    contentPages.forEach(page => {
      page.querySelectorAll('.footnote-ref').forEach(ref => refNodes.push(ref));
    });

    // Map of existing lis by unique id
    const liMap = new Map();
    list.querySelectorAll('li[data-unique-id]').forEach(li => {
      liMap.set(li.dataset.uniqueId, li);
    });

    // If a li was deleted in the footnotes list, drop its refs
    refNodes.slice().forEach(ref => {
      if (!liMap.has(ref.dataset.uniqueId)) {
        const wrapper = ref.parentElement;
        ref.remove();
        if (wrapper && wrapper.classList && wrapper.classList.contains('footnote-target')) {
          cleanupOrphanFootnoteTargets();
        }
      }
    });

    // Re-scan (some refs may have been removed)
    const validRefIds = new Set();
    const updatedRefNodes = [];
    contentPages.forEach(page => {
      page.querySelectorAll('.footnote-ref').forEach(ref => {
        updatedRefNodes.push(ref);
        validRefIds.add(ref.dataset.uniqueId);
      });
    });

    // Remove any lis that no longer have a live ref
    list.querySelectorAll('li[data-unique-id]').forEach(li => {
      if (!validRefIds.has(li.dataset.uniqueId)) {
        li.remove();
      }
    });

    // Now assign compact numbers in DOM order of refs
    const assigned = new Map();   // uniqueId -> number
    const orderedLis = [];
    let counter = 1;

    const currentLis = new Map();
    list.querySelectorAll('li[data-unique-id]').forEach(li => {
      currentLis.set(li.dataset.uniqueId, li);
      // ensure editable
      if (!li.hasAttribute('contenteditable')) {
        li.contentEditable = 'true';
      }
    });

    updatedRefNodes.forEach(ref => {
      const id = ref.dataset.uniqueId;
      if (!currentLis.has(id)) return; // orphan ref already removed or no li
      if (!assigned.has(id)) {
        assigned.set(id, counter++);
      }
      const num = assigned.get(id);
      ref.textContent = '[' + num + ']';
      ref.contentEditable = 'false';
      ref.tabIndex = 0;
      ref.setAttribute('role', 'button');
      ref.setAttribute('aria-label', 'Jump to footnote ' + num);
      ref.id = 'fn-ref-' + num;
      const li = currentLis.get(id);
      if (li) {
        decorateFootnoteListItem(li, num);
      }
    });

    // Order lis by their assigned numbers
    assigned.forEach((num, id) => {
      const li = currentLis.get(id);
      if (li) orderedLis[num - 1] = li;
    });

    const desiredOrder = orderedLis.filter(Boolean);
    desiredOrder.forEach((li, index) => {
      const currentChild = list.children[index];
      if (currentChild === li) return;
      if (currentChild) {
        list.insertBefore(li, currentChild);
      } else {
        list.appendChild(li);
      }
    });

    Array.from(list.children).forEach(child => {
      if (!desiredOrder.includes(child)) {
        child.remove();
      }
    });

    cleanupOrphanFootnoteTargets();
  }

  /* -------- Page + block creation helpers -------- */

  function createOverflowIndicator() {
    const indicator = document.createElement('div');
    indicator.className = 'overflow-indicator';
    indicator.setAttribute('aria-hidden', 'true');
    const pill = document.createElement('span');
    pill.textContent = '!';
    pill.title = 'Consider splitting page';
    pill.setAttribute('aria-label', 'Consider splitting page');
    indicator.appendChild(pill);
    return indicator;
  }

  function decorateDeleteIcon(span) {
    if (!span) return;
    span.classList.add('delete-icon');
    span.contentEditable = 'false';
    span.setAttribute('role', 'button');
    span.setAttribute('tabindex', '0');
    span.setAttribute('aria-label', 'Delete block');
    span.textContent = 'Ã—';
  }

  function createPage(options = {}) {
    const { withDefaultContent = true } = options;
    const div = document.createElement('div');
    div.className = 'page-container';
    div.dataset.pageType = 'content';
    div.innerHTML = `
      <div class="page-controls">
        <button class="page-control-btn" data-move-page-up title="Move page up" aria-label="Move page up">â†‘</button>
        <button class="page-control-btn" data-move-page-down title="Move page down" aria-label="Move page down">â†“</button>
        <button class="page-control-btn" data-dup-page title="Duplicate page" aria-label="Duplicate page">â§‰</button>
        <button class="page-control-btn" data-del-page title="Delete page" aria-label="Delete page">âœ•</button>
      </div>
      <div class="page-overlay"></div>
      <div class="page-body"></div>
      <div class="page-footer"></div>
    `;
    const body = div.querySelector('.page-body');
    if (withDefaultContent) {
      const section = document.createElement('h3');
      section.className = 'section-heading';
      section.dataset.deletable = 'true';
      section.innerHTML = `<span contenteditable="true">New section title</span>${DELETE_ICON_HTML}`;
      const paragraph = document.createElement('p');
      paragraph.className = 'body-text';
      paragraph.dataset.deletable = 'true';
      paragraph.contentEditable = 'true';
      paragraph.innerHTML = `New paragraphâ€¦${DELETE_ICON_HTML}`;
      body.appendChild(section);
      body.appendChild(paragraph);
    }
    body.appendChild(createOverflowIndicator());
    return div;
  }

  function createDocTitleElement(text) {
    const div = document.createElement('div');
    div.className = 'doc-title';
    div.dataset.deletable = 'true';
    div.contentEditable = 'true';
    div.innerHTML = `${text}${DELETE_ICON_HTML}`;
    return div;
  }

  function createDocSubtitleElement(text) {
    const p = document.createElement('p');
    p.className = 'doc-subtitle body-text';
    p.dataset.deletable = 'true';
    p.contentEditable = 'true';
    p.innerHTML = `${text}${DELETE_ICON_HTML}`;
    return p;
  }

  function createSectionHeadingElement(text) {
    const h = document.createElement('h3');
    h.className = 'section-heading';
    h.dataset.deletable = 'true';
    h.innerHTML = `<span contenteditable="true">${text}</span>${DELETE_ICON_HTML}`;
    return h;
  }

  function createBodyParagraphElement(text) {
    const p = document.createElement('p');
    p.className = 'body-text';
    p.dataset.deletable = 'true';
    p.contentEditable = 'true';
    p.innerHTML = `${text}${DELETE_ICON_HTML}`;
    return p;
  }

  function populateIgaBriefTemplate(body) {
    body.appendChild(createDocTitleElement('Executive Brief Title'));
    body.appendChild(createDocSubtitleElement('Short positioning subtitle / context line.'));
    body.appendChild(createSectionHeadingElement('At a glance'));
    body.appendChild(createAtAGlanceTable());
    body.appendChild(createSectionHeadingElement('Key messages'));
    body.appendChild(createBodyParagraphElement('Use this space to summarise the essentials in clear, direct language.'));
    body.appendChild(createSectionHeadingElement('Before / After / Impact'));
    body.appendChild(createBAITable());
    body.appendChild(createSectionHeadingElement('Actions'));
    body.appendChild(createStepsBlock());
    body.appendChild(createSectionHeadingElement('FAQs'));
    body.appendChild(createFaqBlock());
    body.appendChild(createSectionHeadingElement('Sources'));
    body.appendChild(createBodyParagraphElement('List supporting sources and references here.'));
  }

  function populateFtExplainerTemplate(body) {
    body.appendChild(createDocTitleElement('Explainer headline'));
    body.appendChild(createDocSubtitleElement('Optional kicker for FT-style tone.'));
    body.appendChild(createSectionHeadingElement('Context'));
    body.appendChild(createBodyParagraphElement('Set the context with a succinct summary and key framing.'));
    body.appendChild(createSectionHeadingElement('Key messages'));
    const cta = createCtaBox();
    const titleEl = cta.querySelector('.cta-title');
    const bodyEl = cta.querySelector('.cta-body');
    if (titleEl) titleEl.textContent = 'Key message';
    if (bodyEl) bodyEl.textContent = 'Use this callout to highlight the most important takeaway.';
    cta.dataset.customTitle = 'true';
    body.appendChild(cta);
    body.appendChild(createSectionHeadingElement('What changed'));
    body.appendChild(createBodyParagraphElement('Explain what has changed and why it matters for the audience.'));
    body.appendChild(createSectionHeadingElement('Implications'));
    body.appendChild(createBodyParagraphElement('Spell out what readers should do or think differently as a result.'));
    body.appendChild(createSectionHeadingElement('FAQs'));
    body.appendChild(createFaqBlock());
    body.appendChild(createSectionHeadingElement('Sources'));
    body.appendChild(createBodyParagraphElement('Include supporting evidence, links or appendices.'));
  }

  const TEMPLATE_BUILDERS = {
    'iga-brief': populateIgaBriefTemplate,
    'ft-explainer': populateFtExplainerTemplate
  };

  function applyTemplate(templateKey) {
    const builder = TEMPLATE_BUILDERS[templateKey];
    if (!builder) return;
    if (!window.confirm('Applying a template will replace the current content. Continue?')) return;
    captureSnapshot();
    Array.from(editorRoot.querySelectorAll('.page-container:not(.footnotes-page)')).forEach(page => page.remove());
    const newPage = createPage({ withDefaultContent: false });
    const footnotes = editorRoot.querySelector('.footnotes-page');
    editorRoot.insertBefore(newPage, footnotes);
    const body = newPage.querySelector('.page-body');
    builder(body);
    updatePageNumbers();
    renumberFootnotes();
    initAllTableResizers();
    checkAllPageOverflow();
    afterChange();
    ensureBlockVisible(newPage);
    showSnackbar('Template applied');
  }

  function addPage() {
    captureSnapshot();
    const footnotes = editorRoot.querySelector('.footnotes-page');
    const page = createPage();
    editorRoot.insertBefore(page, footnotes);
    updatePageNumbers();
    renumberFootnotes();
    afterChange();
    ensureBlockVisible(page);
  }

  function addSectionBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const h = document.createElement('h3');
    h.className = 'section-heading';
    h.dataset.deletable = 'true';
    h.innerHTML = `<span contenteditable="true">New section title</span>${DELETE_ICON_HTML}`;
    body.appendChild(h);
    afterChange();
    ensureBlockVisible(h);
  }

  function addTextBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const p = document.createElement('p');
    p.className = 'body-text';
    p.dataset.deletable = 'true';
    p.contentEditable = 'true';
    p.innerHTML = `New paragraphâ€¦${DELETE_ICON_HTML}`;
    body.appendChild(p);
    afterChange();
    ensureBlockVisible(p);
  }

  function createCtaBox() {
    const div = document.createElement('div');
    div.className = 'cta-box cta-blue page-break-avoider';
    div.dataset.deletable = 'true';
    div.dataset.generatedTitle = 'Info';
    div.innerHTML = `
      ${DELETE_ICON_HTML}
      <div class="cta-type-switch" contenteditable="false">
        <button data-cta="cta-blue" class="active">Info</button>
        <button data-cta="cta-green">Action</button>
        <button data-cta="cta-yellow">Caution</button>
        <button data-cta="cta-red">Critical</button>
      </div>
      <div class="cta-title" contenteditable="true">Info</div>
      <div class="cta-body" contenteditable="true">Key message textâ€¦</div>
    `;
    return div;
  }

  function addCtaBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const cta = createCtaBox();
    body.appendChild(cta);
    afterChange();
    ensureBlockVisible(cta);
  }

  function createStepsBlock() {
    const div = document.createElement('div');
    div.className = 'steps-block page-break-avoider';
    div.dataset.deletable = 'true';
    div.innerHTML = `
      ${DELETE_ICON_HTML}
      <div class="steps-title" contenteditable="true">Steps for implementation</div>
      <ol class="styled-steps">
        <li contenteditable="true">Step 1â€¦</li>
        <li contenteditable="true">Step 2â€¦</li>
        <li contenteditable="true">Step 3â€¦</li>
      </ol>
      <button class="steps-add" contenteditable="false">+ Add step</button>
    `;
    return div;
  }

  function addStepsBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const block = createStepsBlock();
    body.appendChild(block);
    afterChange();
    ensureBlockVisible(block);
  }

  function createFaqBlock() {
    const div = document.createElement('div');
    div.className = 'faq-block page-break-avoider';
    div.dataset.deletable = 'true';
    div.innerHTML = `
      ${DELETE_ICON_HTML}
      <div class="faq-title" contenteditable="true">Frequently asked questions</div>
      <ol class="faq-list">
        <li>
          <div class="faq-q" contenteditable="true">Q: â€¦</div>
          <div class="faq-a" contenteditable="true">A: â€¦</div>
        </li>
      </ol>
      <button class="faq-add" contenteditable="false">+ Add FAQ</button>
    `;
    return div;
  }

  function addFaqBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const block = createFaqBlock();
    body.appendChild(block);
    afterChange();
    ensureBlockVisible(block);
  }

  function addQuoteBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const div = document.createElement('div');
    div.className = 'quote-block';
    div.dataset.deletable = 'true';
    div.innerHTML = `
      ${DELETE_ICON_HTML}
      <blockquote class="quote-body" contenteditable="true">â€œQuoted textâ€¦â€</blockquote>
      <div class="quote-source" contenteditable="true">Source / speaker (optional)</div>
    `;
    body.appendChild(div);
    afterChange();
    ensureBlockVisible(div);
  }

  function addDividerBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const div = document.createElement('div');
    div.className = 'divider-block page-break-avoider';
    div.dataset.deletable = 'true';
    div.innerHTML = `
      <hr class="section-divider" />
      ${DELETE_ICON_HTML}
    `;
    body.appendChild(div);
    afterChange();
    ensureBlockVisible(div);
  }

  function addCitationBlock() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const p = document.createElement('p');
    p.className = 'citation-block';
    p.dataset.deletable = 'true';
    p.contentEditable = 'true';
    p.innerHTML = `(Source: â€¦)${DELETE_ICON_HTML}`;
    body.appendChild(p);
    afterChange();
    ensureBlockVisible(p);
  }

  function createAtAGlanceTable() {
    const div = document.createElement('div');
    div.className = 'table-block page-break-avoider';
    div.dataset.deletable = 'true';
    div.innerHTML = `
      ${DELETE_ICON_HTML}
      <table class="iga-table">
        <thead>
          <tr>
            <th contenteditable="true">Theme</th>
            <th contenteditable="true">Detail</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td contenteditable="true">Audience</td>
            <td contenteditable="true">Who this is forâ€¦</td>
          </tr>
          <tr>
            <td contenteditable="true">Objective</td>
            <td contenteditable="true">What we need them to doâ€¦</td>
          </tr>
          <tr>
            <td contenteditable="true">Timing</td>
            <td contenteditable="true">Key datesâ€¦</td>
          </tr>
        </tbody>
      </table>
      <div class="table-controls" contenteditable="false">
        <button data-table-action="add-row">+ Row</button>
        <button data-table-action="add-col">+ Col</button>
        <button data-table-action="del-row">- Row</button>
        <button data-table-action="del-col">- Col</button>
      </div>
    `;
    const table = div.querySelector('table');
    initTableResizing(table);
    return div;
  }

  function createBAITable() {
    const div = document.createElement('div');
    div.className = 'table-block page-break-avoider';
    div.dataset.deletable = 'true';
    div.innerHTML = `
      ${DELETE_ICON_HTML}
      <table class="iga-table">
        <thead>
          <tr>
            <th contenteditable="true">Before</th>
            <th contenteditable="true">After</th>
            <th contenteditable="true">Impact</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td contenteditable="true">Current stateâ€¦</td>
            <td contenteditable="true">Target stateâ€¦</td>
            <td contenteditable="true">Outcome / benefitâ€¦</td>
          </tr>
        </tbody>
      </table>
      <div class="table-controls" contenteditable="false">
        <button data-table-action="add-row">+ Row</button>
        <button data-table-action="add-col">+ Col</button>
        <button data-table-action="del-row">- Row</button>
        <button data-table-action="del-col">- Col</button>
      </div>
    `;
    const table = div.querySelector('table');
    initTableResizing(table);
    return div;
  }

  function addAtAGlanceTable() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const block = createAtAGlanceTable();
    body.appendChild(block);
    afterChange();
    ensureBlockVisible(block);
  }

  function addBAITable() {
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const block = createBAITable();
    body.appendChild(block);
    afterChange();
    ensureBlockVisible(block);
  }

  function openCustomTableModal() {
    openModal({
      title: 'Add custom table',
      body: `
        <label>Rows</label>
        <input type="number" id="tbl-rows" min="1" max="40" value="3" />
        <label>Columns</label>
        <input type="number" id="tbl-cols" min="1" max="8" value="3" />
        <label>Or paste TSV (overrides rows/cols)</label>
        <textarea id="tbl-tsv" rows="4" placeholder="cell1\tcell2\ncell3\tcell4"></textarea>
      `,
      onConfirm: () => {
        const rowsInput = modalInner.querySelector('#tbl-rows');
        const colsInput = modalInner.querySelector('#tbl-cols');
        const tsvInput = modalInner.querySelector('#tbl-tsv');
        const tsv = (tsvInput.value || '').trim();
        let rows = parseInt(rowsInput.value, 10) || 1;
        let cols = parseInt(colsInput.value, 10) || 1;

        let data = [];
        if (tsv) {
          const lines = tsv.split(/\r?\n/);
          lines.forEach(line => {
            const cells = line.split('\t');
            data.push(cells);
            if (cells.length > cols) cols = cells.length;
          });
          rows = data.length;
        }

        const body = getActiveContentPageBody();
        if (!body) {
          closeModal();
          return;
        }

        captureSnapshot();

        const block = document.createElement('div');
        block.className = 'table-block page-break-avoider';
        block.dataset.deletable = 'true';

        let html = `
          ${DELETE_ICON_HTML}
          <table class="iga-table">
            <tbody>
        `;
        for (let r = 0; r < rows; r++) {
          html += '<tr>';
          for (let c = 0; c < cols; c++) {
            const txt = data[r] && data[r][c] ? data[r][c] : ' ';
            html += `<td contenteditable="true">${txt}</td>`;
          }
          html += '</tr>';
        }
        html += `
            </tbody>
          </table>
          <div class="table-controls" contenteditable="false">
            <button data-table-action="add-row">+ Row</button>
            <button data-table-action="add-col">+ Col</button>
            <button data-table-action="del-row">- Row</button>
            <button data-table-action="del-col">- Col</button>
          </div>
        `;
        block.innerHTML = html;
        const table = block.querySelector('table');
        initTableResizing(table);
        body.appendChild(block);
        afterChange();
        ensureBlockVisible(block);
        closeModal();
      }
    });
  }

  function addImageBlockWithURL(url) {
    if (!url) return;
    const body = getActiveContentPageBody();
    if (!body) return;
    captureSnapshot();
    const div = document.createElement('div');
    div.className = 'image-block image-size-m page-break-avoider';
    div.dataset.deletable = 'true';
    div.innerHTML = `
      ${DELETE_ICON_HTML}
      <div class="image-size-controls" contenteditable="false">
        <button data-size="s">S</button>
        <button data-size="m" class="active">M</button>
        <button data-size="l">L</button>
      </div>
      <img src="${url}" alt="">
      <div class="image-caption" contenteditable="true">Add an explanatory captionâ€¦</div>
    `;
    body.appendChild(div);
    afterChange();
    ensureBlockVisible(div);
  }

  function openImageModal() {
    openModal({
      title: 'Add image',
      body: `
        <label>Image URL</label>
        <input type="url" id="img-url" placeholder="https://example.com/image.png" />
      `,
      onConfirm: () => {
        const input = modalInner.querySelector('#img-url');
        const url = input.value.trim();
        if (!url) {
          showSnackbar('Image URL required');
          return;
        }
        addImageBlockWithURL(url);
        closeModal();
      }
    });
  }

  /* -------- Modal helpers -------- */

  function openModal({ title, body, onConfirm, onCancel, confirmLabel = 'OK', cancelLabel = 'Cancel' }) {
    modalInner.innerHTML = `
      <h3>${title}</h3>
      ${body}
      <div class="modal-actions">
        <button type="button" data-modal-cancel>Cancel</button>
        <button type="button" class="primary" data-modal-confirm>OK</button>
      </div>
    `;
    modalBackdrop.classList.add('visible');
    const cancelBtn = modalInner.querySelector('[data-modal-cancel]');
    const confirmBtn = modalInner.querySelector('[data-modal-confirm]');
    if (cancelBtn) {
      cancelBtn.textContent = cancelLabel;
      cancelBtn.onclick = () => {
        if (typeof onCancel === 'function') {
          onCancel();
        } else {
          closeModal();
        }
      };
    }
    if (confirmBtn) {
      confirmBtn.textContent = confirmLabel;
      confirmBtn.onclick = () => {
        if (typeof onConfirm === 'function') {
          onConfirm();
        } else {
          closeModal();
        }
      };
    }
  }

  function closeModal() {
    modalBackdrop.classList.remove('visible');
    modalInner.innerHTML = '';
  }

  /* -------- Table controls + resizing -------- */

  function handleTableControl(btn) {
    const action = btn.dataset.tableAction;
    const block = btn.closest('.table-block');
    if (!block) return;
    const table = block.querySelector('table');
    if (!table) return;

    captureSnapshot();

    if (action === 'add-row') {
      const tbody = table.tBodies[0] || table.createTBody();
      const refRow = tbody.rows[tbody.rows.length - 1] || (table.tHead && table.tHead.rows[0]);
      const cols = refRow ? refRow.cells.length : 1;
      const row = tbody.insertRow(-1);
      for (let i = 0; i < cols; i++) {
        const cell = row.insertCell(-1);
        cell.contentEditable = 'true';
        cell.textContent = ' ';
      }
    } else if (action === 'add-col') {
      const rows = table.rows;
      for (let r = 0; r < rows.length; r++) {
        const cell = rows[r].insertCell(-1);
        cell.contentEditable = 'true';
        cell.textContent = ' ';
      }
    } else if (action === 'del-row') {
      const tbody = table.tBodies[0];
      if (tbody && tbody.rows.length > 0) tbody.deleteRow(-1);
    } else if (action === 'del-col') {
      const rows = table.rows;
      if (rows.length && rows[0].cells.length > 1) {
        for (let r = 0; r < rows.length; r++) {
          rows[r].deleteCell(-1);
        }
      }
    }

    const tbody = table.tBodies[0];
    if ((!tbody || !tbody.rows.length) && (!table.tHead || !table.tHead.rows.length)) {
      block.remove();
    }

    initTableResizing(table);
    afterChange();
  }

  function initTableResizing(table) {
    if (!table) return;
    // Remove existing handles
    table.querySelectorAll('.col-resize-handle').forEach(h => h.remove());

    const headerRow =
      (table.tHead && table.tHead.rows[0]) ||
      (table.tBodies[0] && table.tBodies[0].rows[0]);

    if (!headerRow) return;

    const cells = Array.from(headerRow.cells);
    if (cells.length <= 1) return;

    cells.forEach((cell, index) => {
      // Optional: skip last column handle if you prefer
      if (index === cells.length - 1) return;

      const handle = document.createElement('div');
      handle.className = 'col-resize-handle';
      handle.contentEditable = 'false';
      handle.addEventListener('mousedown', e => {
        e.preventDefault();
        e.stopPropagation();
        startColumnResize(table, index, e);
      });
      cell.appendChild(handle);
    });
  }

  function startColumnResize(table, colIndex, event) {
    const startX = event.clientX;
    const colCells = Array.from(table.rows)
      .map(row => row.cells[colIndex])
      .filter(Boolean);
    if (!colCells.length) return;

    const startWidths = colCells.map(cell => cell.offsetWidth);

    tableResizeState = {
      table,
      colCells,
      startX,
      startWidths
    };

    document.addEventListener('mousemove', handleColumnResizeMove);
    document.addEventListener('mouseup', stopColumnResize);
  }

  function handleColumnResizeMove(e) {
    if (!tableResizeState) return;
    const deltaX = e.clientX - tableResizeState.startX;

    tableResizeState.colCells.forEach((cell, i) => {
      const base = tableResizeState.startWidths[i];
      const next = Math.max(40, base + deltaX);
      cell.style.width = next + 'px';
    });

    e.preventDefault();
  }

  function stopColumnResize() {
    if (!tableResizeState) return;
    document.removeEventListener('mousemove', handleColumnResizeMove);
    document.removeEventListener('mouseup', stopColumnResize);
    tableResizeState = null;
    scheduleInputSnapshot();
  }

  function initAllTableResizers() {
    editorRoot.querySelectorAll('table.iga-table').forEach(initTableResizing);
  }

  /* -------- Paste / sanitize / clipboard -------- */

  function insertPastedImage(file) {
    const reader = new FileReader();
    reader.onload = e => addImageBlockWithURL(e.target.result);
    reader.readAsDataURL(file);
  }

  function sanitizeExternalHTML(html) {
    const allowedTags = new Set([
      'P','H1','H2','H3','H4','UL','OL','LI','A','STRONG','EM',
      'B','I','TABLE','TBODY','THEAD','TR','TD','TH','BLOCKQUOTE','BR','SPAN'
    ]);
    const allowedAttrs = {
      'A': ['href'],
      'TD': [], 'TH': [], 'TABLE': [], 'TR': [], 'P': [], 'BLOCKQUOTE': [], 'SPAN': []
    };
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    function cleanse(node) {
      if (node.nodeType === Node.TEXT_NODE) return node.cloneNode(true);
      if (node.nodeType !== Node.ELEMENT_NODE) return document.createTextNode('');
      if (!allowedTags.has(node.tagName)) {
        const frag = document.createDocumentFragment();
        node.childNodes.forEach(child => {
          const c = cleanse(child);
          if (c) frag.appendChild(c);
        });
        return frag;
      }
      const el = document.createElement(node.tagName.toLowerCase());
      const allowed = allowedAttrs[node.tagName] || [];
      for (let attr of Array.from(node.attributes)) {
        if (attr.name.toLowerCase() === 'href' && /^https?:\/\//i.test(attr.value)) {
          el.setAttribute('href', attr.value);
        } else if (allowed.includes(attr.name.toLowerCase())) {
          el.setAttribute(attr.name, attr.value);
        }
      }
      node.childNodes.forEach(child => {
        const c = cleanse(child);
        if (c) el.appendChild(c);
      });
      return el;
    }

    const frag = document.createDocumentFragment();
    doc.body.childNodes.forEach(child => {
      const c = cleanse(child);
      if (c) frag.appendChild(c);
    });
    return frag;
  }

  function handlePaste(e) {
    if (!isInEditor(e.target)) return;
    const cd = e.clipboardData || window.clipboardData;
    if (!cd) return;

    const items = cd.items || [];
    for (let i = 0; i < items.length; i++) {
      const it = items[i];
      if (it.type && it.type.indexOf('image') === 0) {
        e.preventDefault();
        const file = it.getAsFile();
        if (file) insertPastedImage(file);
        return;
      }
    }

    const html = cd.getData('text/html');
    const text = cd.getData('text/plain');

    // Internal block copy/paste
    if (html && html.includes(INTERNAL_MARKER_START) && html.includes(INTERNAL_MARKER_END)) {
      e.preventDefault();
      const start = html.indexOf(INTERNAL_MARKER_START) + INTERNAL_MARKER_START.length;
      const end = html.indexOf(INTERNAL_MARKER_END);
      const blockHtml = html.slice(start, end);
      insertInternalBlocks(blockHtml);
      return;
    }

    if (html) {
      e.preventDefault();
      const safe = sanitizeExternalHTML(html);
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      captureSnapshot();
      const range = sel.getRangeAt(0);
      range.deleteContents();
      range.insertNode(safe);
      afterChange();
      return;
    }

    if (text) {
      e.preventDefault();
      const normalized = text.replace(/\r\n/g, '\n');
      const paragraphs = normalized
        .split(/\n{2,}/)
        .map(seg => seg.trim())
        .filter(seg => seg.length);

      if (!paragraphs.length) return;

      const escapeHtml = str => str.replace(/[&<>"']/g, ch => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[ch]);

      const sel = window.getSelection();
      if (sel && sel.rangeCount) {
        const range = sel.getRangeAt(0);
        const container = range.commonAncestorContainer.nodeType === Node.ELEMENT_NODE
          ? range.commonAncestorContainer
          : range.commonAncestorContainer.parentElement;
        const pageBody = container && container.closest('.page-body');

        if (pageBody) {
          captureSnapshot();
          const page = pageBody.closest('.page-container');
          if (page && page.classList.contains('footnotes-page')) {
            const inlineHtml = paragraphs
              .map(seg => escapeHtml(seg).replace(/\n/g, '<br>'))
              .join('<br><br>');
            document.execCommand('insertHTML', false, inlineHtml);
          } else {
            const blockHtml = paragraphs
              .map(seg => {
                const html = escapeHtml(seg).replace(/\n/g, '<br>');
                return `<p class="body-text" data-deletable="true" contenteditable="true">${html}${DELETE_ICON_HTML}</p>`;
              })
              .join('');
            document.execCommand('insertHTML', false, blockHtml);
          }
          afterChange();
          return;
        }
      }

      const body = getActiveContentPageBody();
      if (!body) return;
      captureSnapshot();
      paragraphs.forEach(seg => {
        const p = document.createElement('p');
        p.className = 'body-text';
        p.dataset.deletable = 'true';
        p.contentEditable = 'true';
        const lines = seg.split('\n');
        lines.forEach((line, index) => {
          if (index > 0) p.appendChild(document.createElement('br'));
          p.appendChild(document.createTextNode(line));
        });
        const icon = document.createElement('span');
        decorateDeleteIcon(icon);
        p.appendChild(icon);
        body.appendChild(p);
      });
      afterChange();
    }
  }

  function insertInternalBlocks(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    const blocks = Array.from(tmp.children);
    if (!blocks.length) return;

    const lastSelected = getLastSelectedBlock();
    const sel = window.getSelection();
    let insertAfter = lastSelected;

    if (!insertAfter && sel && sel.rangeCount) {
      const node = sel.anchorNode;
      const el = node && (node.nodeType === 1 ? node : node.parentElement);
      const blk = el && el.closest('[data-deletable="true"]');
      if (blk && !blk.closest('.footnotes-page')) insertAfter = blk;
    }

    const body = insertAfter ? insertAfter.closest('.page-body') : getActiveContentPageBody();
    if (!body) return;

    captureSnapshot();

    blocks.forEach(b => {
      if (b.dataset && b.dataset.deletable === 'true') {
        const clone = b.cloneNode(true);
        if (insertAfter) {
          insertAfter.insertAdjacentElement('afterend', clone);
          insertAfter = clone;
        } else {
          body.appendChild(clone);
        }
      }
    });

    renumberFootnotes();
    afterChange();
  }

  function copySelectedBlocks(isCut = false) {
    const blocks = getSelectedBlocks();
    if (!blocks.length) {
      showSnackbar('Select block(s) to copy');
      return;
    }
    const html = blocks.map(b => b.outerHTML).join('');
    internalClipboardHTML = html;
    const wrapped = INTERNAL_MARKER_START + html + INTERNAL_MARKER_END;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(wrapped).catch(() => {});
    }
    if (isCut) {
      captureSnapshot();
      blocks.forEach(b => b.remove());
      renumberFootnotes();
      afterChange();
      clearBlockSelection();
    }
    showSnackbar(isCut ? 'Block(s) cut' : 'Block(s) copied', 1200);
  }

  function pasteBlocksAfterSelection() {
    if (!internalClipboardHTML) {
      showSnackbar('Clipboard is empty');
      return;
    }
    insertInternalBlocks(internalClipboardHTML);
  }

  function moveBlocksToNewPage() {
    const blocks = getSelectedBlocks();
    if (!blocks.length) {
      showSnackbar('Select block(s) to move');
      return;
    }

    captureSnapshot();

    const sorted = blocks.slice().sort((a, b) =>
      a.compareDocumentPosition(b) & Node.DOCUMENT_POSITION_FOLLOWING ? -1 : 1
    );

    const anchor = sorted[sorted.length - 1];
    const anchorPage = anchor.closest('.page-container');
    const newPage = createPage({ withDefaultContent: false });
    const footnotes = editorRoot.querySelector('.footnotes-page');

    if (anchorPage && !anchorPage.classList.contains('footnotes-page')) {
      anchorPage.insertAdjacentElement('afterend', newPage);
    } else {
      editorRoot.insertBefore(newPage, footnotes);
    }

    const body = newPage.querySelector('.page-body');
    sorted.forEach(block => body.appendChild(block));

    updatePageNumbers();
    renumberFootnotes();
    checkAllPageOverflow();
    afterChange();

    clearBlockSelection();
    sorted.forEach(block => block.classList.add('block-selected'));
    showBlockActions();
    if (sorted[0]) ensureBlockVisible(sorted[0]);
    showSnackbar('Moved blocks to new page');
  }

  function moveBlocks(direction) {
    const blocks = getSelectedBlocks();
    if (!blocks.length) return;
    captureSnapshot();

    const sorted = blocks.slice().sort((a, b) =>
      a.compareDocumentPosition(b) & Node.DOCUMENT_POSITION_FOLLOWING ? -1 : 1
    );
    const isUp = direction === 'up';

    if (isUp) {
      sorted.forEach(block => {
        const prev = block.previousElementSibling;
        if (prev && prev.dataset.deletable === 'true') prev.before(block);
      });
    } else {
      sorted.reverse().forEach(block => {
        const next = block.nextElementSibling;
        if (next && next.dataset.deletable === 'true') next.after(block);
      });
    }

    renumberFootnotes();
    afterChange();
    showBlockActions();
  }

  function duplicateBlocks() {
    const blocks = getSelectedBlocks();
    if (!blocks.length) return;
    captureSnapshot();
    let lastClone = null;
    blocks.forEach(block => {
      const clone = block.cloneNode(true);
      block.insertAdjacentElement('afterend', clone);
      lastClone = clone;
    });
    renumberFootnotes();
    afterChange();
    clearBlockSelection();
    if (lastClone) {
      lastClone.classList.add('block-selected');
      ensureBlockVisible(lastClone);
      showBlockActions();
    }
  }

  function deleteBlocks() {
    const blocks = getSelectedBlocks();
    if (!blocks.length) return;
    captureSnapshot();
    blocks.forEach(b => b.remove());
    renumberFootnotes();
    afterChange();
    clearBlockSelection();
  }

  function collectQualityIssues() {
    const issues = new Set();
    const placeholderHits = new Set();
    const scanNodes = editorRoot.querySelectorAll('[data-deletable="true"], td, th, .steps-block li, .faq-block .faq-q, .faq-block .faq-a, .image-caption');
    scanNodes.forEach(node => {
      const text = (node.textContent || '').trim();
      if (!text) return;
      QUALITY_PLACEHOLDERS.forEach(placeholder => {
        if (text.includes(placeholder)) placeholderHits.add(placeholder);
      });
    });
    if (placeholderHits.size) {
      issues.add('Replace placeholder copy: ' + Array.from(placeholderHits).join(', '));
    }

    editorRoot.querySelectorAll('.cta-box').forEach(box => {
      const titleEl = box.querySelector('.cta-title');
      const bodyEl = box.querySelector('.cta-body');
      const title = titleEl ? titleEl.textContent.trim() : '';
      const body = bodyEl ? bodyEl.textContent.trim() : '';
      const customTitle = box.dataset.customTitle === 'true';
      if ((!customTitle && title === 'Info') || body === 'Key message textâ€¦') {
        issues.add('Update CTA blocks so they no longer use default Info / Key message text.');
      }
    });

    editorRoot.querySelectorAll('.image-block').forEach(block => {
      const img = block.querySelector('img');
      const altText = img ? (img.getAttribute('alt') || '').trim() : '';
      const captionEl = block.querySelector('.image-caption');
      const captionText = captionEl ? captionEl.textContent.trim() : '';
      if (!altText) {
        issues.add('Provide alt text for all images.');
      }
      if (!captionText || captionText === 'Add an explanatory captionâ€¦') {
        issues.add('Add explanatory captions for images.');
      }
    });

    const unresolvedRefs = Array.from(editorRoot.querySelectorAll('.footnote-ref')).some(ref => (ref.textContent || '').includes('?'));
    if (unresolvedRefs) {
      issues.add('Resolve placeholder footnote references [?].');
    }

    return Array.from(issues);
  }

  function runQualityCheck(options = {}) {
    const { onContinue, showNoIssues = true } = options;
    const issues = collectQualityIssues();
    if (!issues.length) {
      if (showNoIssues) showSnackbar('No quality issues found');
      if (typeof onContinue === 'function') onContinue();
      return;
    }

    const listItems = issues.map(issue => `<li>${issue}</li>`).join('');
    openModal({
      title: 'Quality check',
      body: `<p>Fix these before finalising your brief:</p><ul>${listItems}</ul>`,
      confirmLabel: onContinue ? 'Continue anyway' : 'OK',
      cancelLabel: 'Close',
      onConfirm: () => {
        closeModal();
        if (typeof onContinue === 'function') onContinue();
      },
      onCancel: closeModal
    });
  }

  function showHelpModal() {
    const body = `
      <div class="help-modal-content">
        <p><strong>Selecting blocks:</strong> Click inside any block to select it. Use Ctrl/Cmd + click to multi-select and the floating menu to move, duplicate or delete.</p>
        <p><strong>CTA colours:</strong></p>
        <ul>
          <li><strong>Info</strong> â€” neutral context or updates.</li>
          <li><strong>Action</strong> â€” tasks and next steps.</li>
          <li><strong>Caution</strong> â€” risks or watch-outs.</li>
          <li><strong>Critical</strong> â€” urgent blockers or escalations.</li>
        </ul>
        <p><strong>Tables:</strong></p>
        <ul>
          <li><em>At-a-glance</em> covers audience, objective and timing.</li>
          <li><em>Before / After / Impact</em> captures the change story.</li>
          <li>Use custom tables for bespoke layouts.</li>
        </ul>
        <p><strong>Footnotes:</strong> Select text and press â€œ+ Footnoteâ€ to wrap it. Click a reference to jump to its note and use the â†© button to return.</p>
      </div>
    `;
    openModal({
      title: 'Quick help',
      body,
      confirmLabel: 'Got it',
      cancelLabel: 'Close',
      onConfirm: closeModal,
      onCancel: closeModal
    });
  }

  /* -------- Export / import -------- */

  function exportJSON() {
    const performExport = () => {
      const theme = getCurrentTheme();
      clearBlockSelection();
      hideTextToolbar();
      hideBlockActions();
      const content = `<main id="editor-root">${editorRoot.innerHTML}</main>`;
      const payload = {
        version: '1.0.0',
        timestamp: new Date().toISOString(),
        theme,
        content
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'executive-brief.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showSnackbar('JSON exported');
    };

    runQualityCheck({ onContinue: performExport });
  }

  function importJSONFromFile(file) {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const obj = JSON.parse(e.target.result);
        if (!obj.content) throw new Error('Missing content');
        const parser = new DOMParser();
        const doc = parser.parseFromString(obj.content, 'text/html');
        const main = doc.querySelector('main#editor-root') || doc.querySelector('main') || doc.body;
        if (!main) throw new Error('Invalid content wrapper');

        suppressSnapshots = true;
        editorRoot.innerHTML = main.innerHTML;
        setTheme(obj.theme === 'ft' ? 'ft' : 'iga');
        ensureFootnotesPage();
        updatePageNumbers();
        renumberFootnotes();
        initAllTableResizers();
        suppressSnapshots = false;
        initHistory();
        showSnackbar('JSON imported');
      } catch (err) {
        console.error(err);
        showSnackbar('Import failed: ' + err.message);
        suppressSnapshots = false;
      }
    };
    reader.readAsText(file);
  }

  function scheduleInputSnapshot() {
    if (suppressSnapshots || inputSnapshotTimer) return;
    captureSnapshot();
    inputSnapshotTimer = setTimeout(() => {
      afterChange();
      inputSnapshotTimer = null;
    }, 400);
  }

  /* -------- Global click handler -------- */

  document.addEventListener('click', e => {
    const target = e.target;

    const footnoteReturn = target.closest('.footnote-return');
    if (footnoteReturn) {
      e.preventDefault();
      e.stopPropagation();
      scrollToFootnoteRef(footnoteReturn.dataset.uniqueId);
      return;
    }

    const footnoteRef = target.closest('.footnote-ref');
    if (footnoteRef) {
      e.preventDefault();
      e.stopPropagation();
      scrollToFootnoteNote(footnoteRef.dataset.uniqueId);
      return;
    }

    // Delete icon for blocks (not used on footnotes page)
    if (target.classList.contains('delete-icon')) {
      const block = target.closest('[data-deletable="true"]');
      if (block && editorRoot.contains(block) && !block.closest('.footnotes-page')) {
        captureSnapshot();
        block.remove();
        renumberFootnotes();
        afterChange();
        clearBlockSelection();
      }
      return;
    }

    if (target.classList.contains('steps-add')) {
      const block = target.closest('.steps-block');
      const ol = block && block.querySelector('.styled-steps');
      if (ol) {
        captureSnapshot();
        const li = document.createElement('li');
        li.contentEditable = 'true';
        li.textContent = 'New stepâ€¦';
        ol.appendChild(li);
        afterChange();
      }
      return;
    }

    if (target.classList.contains('faq-add')) {
      const block = target.closest('.faq-block');
      const ol = block && block.querySelector('.faq-list');
      if (ol) {
        captureSnapshot();
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="faq-q" contenteditable="true">Q: â€¦</div>
          <div class="faq-a" contenteditable="true">A: â€¦</div>
        `;
        ol.appendChild(li);
        afterChange();
      }
      return;
    }

    if (target.closest('.cta-type-switch') && target.dataset.cta) {
      const box = target.closest('.cta-box');
      if (box) {
        captureSnapshot();
        box.classList.remove('cta-blue','cta-green','cta-yellow','cta-red');
        box.classList.add(target.dataset.cta);
        box.querySelectorAll('.cta-type-switch button').forEach(btn => btn.classList.remove('active'));
        target.classList.add('active');
        const titleEl = box.querySelector('.cta-title');
        if (titleEl && !box.dataset.customTitle) {
          const map = {
            'cta-blue':'Info',
            'cta-green':'Action',
            'cta-yellow':'Caution',
            'cta-red':'Critical'
          };
          titleEl.textContent = map[target.dataset.cta] || 'Info';
          box.dataset.generatedTitle = titleEl.textContent;
        }
        afterChange();
      }
      return;
    }

    if (target.closest('.table-controls') && target.dataset.tableAction) {
      handleTableControl(target);
      return;
    }

    if (target.closest('.image-size-controls') && target.dataset.size) {
      const block = target.closest('.image-block');
      if (block) {
        captureSnapshot();
        block.classList.remove('image-size-s','image-size-m','image-size-l');
        block.classList.add('image-size-' + target.dataset.size);
        block.querySelectorAll('.image-size-controls button')
          .forEach(btn => btn.classList.remove('active'));
        target.classList.add('active');
        afterChange();
      }
      return;
    }

    // Page controls
    if (target.dataset.movePageUp !== undefined ||
        target.dataset.movePageDown !== undefined ||
        target.dataset.dupPage !== undefined ||
        target.dataset.delPage !== undefined) {
      const page = target.closest('.page-container');
      if (!page || page.classList.contains('footnotes-page')) return;
      const footnotes = editorRoot.querySelector('.footnotes-page');
      const contentPages = editorRoot.querySelectorAll('.page-container:not(.footnotes-page)');

      if (target.dataset.movePageUp !== undefined) {
        captureSnapshot();
        const prev = page.previousElementSibling;
        if (prev && !prev.classList.contains('footnotes-page')) {
          editorRoot.insertBefore(page, prev);
        }
        updatePageNumbers();
        renumberFootnotes();
        afterChange();
      }

      if (target.dataset.movePageDown !== undefined) {
        captureSnapshot();
        const next = page.nextElementSibling;
        if (next && next !== footnotes) {
          editorRoot.insertBefore(next, page);
        }
        updatePageNumbers();
        renumberFootnotes();
        afterChange();
      }

      if (target.dataset.dupPage !== undefined) {
        captureSnapshot();
        const clone = page.cloneNode(true);
        clone.querySelectorAll('.block-selected').forEach(el => el.classList.remove('block-selected'));
        editorRoot.insertBefore(clone, page.nextElementSibling);
        updatePageNumbers();
        renumberFootnotes();
        initAllTableResizers();
        afterChange();
      }

      if (target.dataset.delPage !== undefined) {
        if (contentPages.length <= 1) {
          showSnackbar('Cannot delete last page');
        } else {
          captureSnapshot();
          page.remove();
          updatePageNumbers();
          renumberFootnotes();
          afterChange();
        }
      }
      return;
    }

    // Floating block actions
    if (target.closest('#block-actions') && target.dataset.action) {
      const action = target.dataset.action;
      if (action === 'move-up') moveBlocks('up');
      else if (action === 'move-down') moveBlocks('down');
      else if (action === 'duplicate') duplicateBlocks();
      else if (action === 'copy') copySelectedBlocks(false);
      else if (action === 'cut') copySelectedBlocks(true);
      else if (action === 'paste') pasteBlocksAfterSelection();
      else if (action === 'move-to-page') moveBlocksToNewPage();
      else if (action === 'delete') deleteBlocks();
      return;
    }

    // Text toolbar clicks (formatting)
    if (target.closest('#text-toolbar')) {
      const cmdBtn = target.closest('[data-cmd]');
      const actionBtn = target.closest('[data-action]');
      if (cmdBtn && cmdBtn.dataset.cmd) {
        applyInlineCmd(cmdBtn.dataset.cmd);
      } else if (actionBtn) {
        if (actionBtn.dataset.action === 'highlight') {
          toggleHighlight();
        } else if (actionBtn.dataset.action === 'link') {
          const input = document.getElementById('link-input');
          if (input) input.focus();
        } else if (actionBtn.dataset.action === 'unlink') {
          removeLink();
        }
      }
      e.stopPropagation();
      return;
    }

    // Click inside editor body
    if (isInEditor(target)) {
      const block = target.closest('[data-deletable="true"]');
      const inMenu = target.closest('#block-actions');
      if (block && !block.closest('.footnotes-page') && !inMenu) {
        if (e.metaKey || e.ctrlKey) {
          block.classList.toggle('block-selected');
        } else {
          clearBlockSelection();
          block.classList.add('block-selected');
        }
        showBlockActions();
      } else if (!inMenu && !target.closest('#text-toolbar')) {
        clearBlockSelection();
      }
    } else if (!target.closest('#block-actions') && !target.closest('#text-toolbar')) {
      clearBlockSelection();
      hideTextToolbar();
    }
  });

  /* -------- Toolbar inputs -------- */

  document.getElementById('paragraph-style').addEventListener('change', function() {
    if (this.value) applyParagraphStyle(this.value);
    this.value = '';
  });

  textToolbar.addEventListener('mousedown', e => {
    if (e.target.closest('input, textarea, select')) return;
    if (e.target.closest('button')) {
      e.preventDefault();
    }
  });

  document.getElementById('link-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      createLink(e.target.value.trim());
    } else if (e.key === 'Escape') {
      hideTextToolbar();
    }
  });

  document.addEventListener('mouseup', () => setTimeout(updateTextToolbar, 10));
  document.addEventListener('keyup', () => setTimeout(updateTextToolbar, 10));
  window.addEventListener('resize', () => checkAllPageOverflow());

  /* -------- Input handler (CTA + footnotes) -------- */

  editorRoot.addEventListener('input', e => {
    const target = e.target;

    // Track custom CTA title vs auto label
    if (target.classList && target.classList.contains('cta-title')) {
      const box = target.closest('.cta-box');
      if (box && target.textContent.trim() !== (box.dataset.generatedTitle || '').trim()) {
        box.dataset.customTitle = 'true';
      }
    }

    // Edits inside Footnotes page: keep references tidy
    if (target.closest && target.closest('.footnotes-page')) {
      renumberFootnotes();
    }

    scheduleInputSnapshot();
  });

  editorRoot.addEventListener('paste', handlePaste);

  /* -------- Top toolbar buttons -------- */

  document.querySelector('[data-add-page]').addEventListener('click', addPage);
  document.querySelector('[data-add-footnote]').addEventListener('click', addFootnote);

  document.getElementById('theme-select').addEventListener('change', function() {
    captureSnapshot();
    setTheme(this.value === 'ft' ? 'ft' : 'iga');
    afterChange();
  });

  document.getElementById('toggle-overlay').addEventListener('click', () => {
    document.body.classList.toggle('show-overlay');
  });

  document.getElementById('undo-btn').addEventListener('click', undo);
  document.getElementById('redo-btn').addEventListener('click', redo);
  document.getElementById('export-json').addEventListener('click', exportJSON);
  document.getElementById('import-json').addEventListener('click', () => jsonInput.click());
  document.getElementById('print-btn').addEventListener('click', () => window.print());

  jsonInput.addEventListener('change', function() {
    const file = this.files[0];
    if (file) importJSONFromFile(file);
    this.value = '';
  });

  const INSERT_BLOCK_ACTIONS = {
    section: addSectionBlock,
    text: addTextBlock,
    cta: addCtaBlock,
    steps: addStepsBlock,
    faq: addFaqBlock,
    quote: addQuoteBlock,
    divider: addDividerBlock,
    citation: addCitationBlock,
    'table-glance': addAtAGlanceTable,
    'table-bai': addBAITable,
    'table-custom': openCustomTableModal,
    image: openImageModal
  };

  document.querySelectorAll('[data-add]').forEach(btn => {
    btn.addEventListener('click', () => {
      const type = btn.dataset.add;
      const action = INSERT_BLOCK_ACTIONS[type];
      if (typeof action === 'function') action();
    });
  });

  document.querySelectorAll('[data-template]').forEach(btn => {
    btn.addEventListener('click', () => applyTemplate(btn.dataset.template));
  });

  document.getElementById('quality-check-btn').addEventListener('click', () => runQualityCheck({ showNoIssues: true }));
  document.getElementById('help-btn').addEventListener('click', showHelpModal);

  document.addEventListener('keydown', e => {
    const key = e.key;
    if ((key === 'Enter' || key === ' ') && e.target.classList) {
      if (e.target.classList.contains('delete-icon')) {
        e.preventDefault();
        e.stopPropagation();
        e.target.click();
        return;
      }
      if (e.target.classList.contains('footnote-ref')) {
        e.preventDefault();
        scrollToFootnoteNote(e.target.dataset.uniqueId);
        return;
      }
      if (e.target.classList.contains('footnote-return')) {
        e.preventDefault();
        scrollToFootnoteRef(e.target.dataset.uniqueId);
        return;
      }
    }

    if ((e.metaKey || e.ctrlKey) && !e.shiftKey && key.toLowerCase() === 'z') {
      e.preventDefault();
      undo();
    } else if (
      (e.metaKey || e.ctrlKey) &&
      ((e.shiftKey && key.toLowerCase() === 'z') || key.toLowerCase() === 'y')
    ) {
      e.preventDefault();
      redo();
    }
  });

  /* -------- Initialisation -------- */

  ensureFootnotesPage();
  updatePageNumbers();
  renumberFootnotes();
  initAllTableResizers();
  initHistory();
  promptRestoreDraft();
})();
</script>
</body>
</html>
```
